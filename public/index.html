<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Westlake Leaf Collection Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useMemo } = React;

    const statusStyles = {
      'Not Started': 'bg-slate-200 text-slate-900',
      'In Progress': 'bg-amber-100 text-amber-900',
      Completed: 'bg-emerald-100 text-emerald-900',
    };

    function normalizeStatus(value) {
      if (!value) {
        return 'Unknown';
      }

      const normalized = value.trim().toLowerCase();
      switch (normalized) {
        case 'not started':
          return 'Not Started';
        case 'in progress':
        case 'in-progress':
        case 'in progess':
        case 'in proggress':
          return 'In Progress';
        case 'completed':
        case 'complete':
          return 'Completed';
        default:
          return value;
      }
    }

    function StatusBadge({ status = 'Unknown' }) {
      const label = normalizeStatus(status);
      const baseClasses =
        'inline-flex items-center rounded-full px-3 py-1 text-sm font-medium';
      const variant = statusStyles[label] ?? 'bg-slate-100 text-slate-700';

      return (
        <span className={`${baseClasses} ${variant}`}>
          <span className="mr-2 inline-flex h-2 w-2 rounded-full bg-current"></span>
          {label}
        </span>
      );
    }

    function formatDate(value) {
      if (!value) {
        return '--';
      }

      const parsed = new Date(value);
      if (Number.isNaN(parsed.getTime())) {
        return value;
      }

      return new Intl.DateTimeFormat('en-US', { dateStyle: 'medium' }).format(
        parsed
      );
    }

    function App() {
      const [records, setRecords] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [activeId, setActiveId] = useState(null);

      useEffect(() => {
        async function loadData() {
          try {
            const response = await fetch('/api/streets');
            if (!response.ok) {
              throw new Error('Unable to fetch street data.');
            }

            const payload = await response.json();
            setRecords(Array.isArray(payload.records) ? payload.records : []);
          } catch (err) {
            console.error(err);
            setError(
              'Unable to load the latest collection information right now. Please try again soon.'
            );
          } finally {
            setLoading(false);
          }
        }

        loadData();
      }, []);

      const sortedRecords = useMemo(() => {
        return [...records]
          .filter((record) => Boolean(record.street))
          .sort((a, b) => a.street.localeCompare(b.street));
      }, [records]);

      const filteredRecords = useMemo(() => {
        const term = searchTerm.trim().toLowerCase();
        if (!term) {
          return sortedRecords;
        }

        return sortedRecords.filter((record) =>
          record.street.toLowerCase().includes(term)
        );
      }, [sortedRecords, searchTerm]);

      useEffect(() => {
        if (!activeId && filteredRecords.length > 0) {
          setActiveId(filteredRecords[0].id);
        }
      }, [filteredRecords, activeId]);

      const selectedRecord = useMemo(() => {
        if (!activeId) {
          return null;
        }

        return records.find((record) => record.id === activeId) ?? null;
      }, [records, activeId]);

      return (
        <div className="min-h-screen bg-slate-100 px-4 py-10">
          <div className="mx-auto flex max-w-4xl flex-col gap-6">
            <header className="text-center">
              <h1 className="text-3xl font-semibold text-slate-900">
                Westlake Leaf Collection Tracker
              </h1>
              <p className="mt-2 text-sm text-slate-600">
                Search your street to see the latest pickup status. Updated
                daily by the Service Department.
              </p>
            </header>

            <main className="rounded-xl bg-white p-6 shadow-lg ring-1 ring-slate-200">
              <div className="flex flex-col gap-4">
                <label
                  className="text-sm font-medium text-slate-700"
                  htmlFor="street-search"
                >
                  Street name
                </label>
                <input
                  id="street-search"
                  type="search"
                  placeholder="Start typing to find your street"
                  value={searchTerm}
                  onChange={(event) => setSearchTerm(event.target.value)}
                  className="w-full rounded-lg border border-slate-300 px-4 py-2 text-base shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200"
                />
              </div>

              {loading ? (
                <div
                  role="status"
                  aria-live="polite"
                  className="mt-8 rounded-lg bg-slate-50 p-6 text-center text-slate-600"
                >
                  Loading the latest collection routes...
                </div>
              ) : error ? (
                <div className="mt-8 rounded-lg bg-rose-50 p-6 text-sm text-rose-700">
                  {error}
                </div>
              ) : (
                <div className="mt-8 grid gap-6 lg:grid-cols-[2fr,3fr]">
                  <section aria-label="Street results" className="space-y-3">
                    <div className="flex items-center justify-between text-sm text-slate-500">
                      <span>
                        {filteredRecords.length}{' '}
                        {filteredRecords.length === 1 ? 'result' : 'results'}
                      </span>
                      {searchTerm && (
                        <button
                          type="button"
                          onClick={() => {
                            setSearchTerm('');
                            setActiveId(null);
                          }}
                          className="text-sky-600 hover:text-sky-700"
                        >
                          Clear search
                        </button>
                      )}
                    </div>
                    <div className="max-h-80 overflow-y-auto rounded-lg border border-slate-200">
                      {filteredRecords.length === 0 ? (
                        <p className="p-4 text-sm text-slate-500">
                          No streets match that search. Try another name or
                          double-check your spelling.
                        </p>
                      ) : (
                        <ul className="divide-y divide-slate-200">
                          {filteredRecords.map((record) => {
                            const isActive = record.id === activeId;
                            return (
                              <li key={record.id}>
                                <button
                                  type="button"
                                  onClick={() => setActiveId(record.id)}
                                  className={`flex w-full items-center justify-between px-4 py-3 text-left transition ${
                                    isActive
                                      ? 'bg-slate-100'
                                      : 'hover:bg-slate-50'
                                  }`}
                                >
                                  <div>
                                    <p className="font-medium text-slate-900">
                                      {record.street}
                                    </p>
                                    <p className="text-sm text-slate-500">
                                      Route {record.routeNumber || '--'}
                                    </p>
                                  </div>
                                  <StatusBadge status={record.status || 'Unknown'} />
                                </button>
                              </li>
                            );
                          })}
                        </ul>
                      )}
                    </div>
                  </section>

                  <section
                    aria-live="polite"
                    aria-label="Street details"
                    className="space-y-4"
                  >
                    <div className="rounded-lg border border-slate-200 p-6">
                      <h2 className="text-lg font-semibold text-slate-900">
                        Collection details
                      </h2>
                      {selectedRecord ? (
                        <dl className="mt-4 space-y-3 text-sm">
                          <div className="flex items-start justify-between">
                            <dt className="text-slate-600">Street</dt>
                            <dd className="font-medium text-slate-900">
                              {selectedRecord.street}
                            </dd>
                          </div>
                          <div className="flex items-start justify-between">
                            <dt className="text-slate-600">Route</dt>
                            <dd className="font-medium text-slate-900">
                              {selectedRecord.routeNumber || '--'}
                            </dd>
                          </div>
                          <div className="flex items-start justify-between">
                            <dt className="text-slate-600">Status</dt>
                            <dd>
                              <StatusBadge status={selectedRecord.status || 'Unknown'} />
                            </dd>
                          </div>
                          <div className="flex items-start justify-between">
                            <dt className="text-slate-600">Date started</dt>
                            <dd className="font-medium text-slate-900">
                              {formatDate(selectedRecord.dateStarted)}
                            </dd>
                          </div>
                          <div className="flex items-start justify-between">
                            <dt className="text-slate-600">Date completed</dt>
                            <dd className="font-medium text-slate-900">
                              {formatDate(selectedRecord.dateCompleted)}
                            </dd>
                          </div>
                        </dl>
                      ) : filteredRecords.length === 0 ? (
                        <p className="mt-4 text-sm text-slate-500">
                          Start typing to find your street and see its pickup
                          details.
                        </p>
                      ) : (
                        <p className="mt-4 text-sm text-slate-500">
                          Select a street from the list to view its route and
                          collection dates.
                        </p>
                      )}
                    </div>
                    <p className="text-xs text-slate-500">
                      This information reflects the most recent update from the
                      Westlake Service Department.
                    </p>
                  </section>
                </div>
              )}
            </main>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
