<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Westlake Leaf Collection Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
  <script src="https://unpkg.com/gsap@3.12.2/dist/gsap.min.js"></script>
  <style>
    :root {
      /* Primary Colors */
      --primary-green: #1a6b2e;
      --primary-green-dark: #145523;
      --primary-green-hover: #226b38;
      
      /* Accent Colors */
      --accent-blue-overlay: rgba(25, 55, 95, 0.65);
      --accent-gold: #d4af37;
      
      /* Neutral Colors */
      --white: #ffffff;
      --off-white: #f8f9fa;
      --light-gray: #e8e9eb;
      --medium-gray: #6c757d;
      --dark-gray: #343a40;
      --black: #000000;
      
      /* Text Colors */
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --text-on-green: #ffffff;
      --text-on-dark: #ffffff;
      
      /* Background Colors */
      --bg-primary: #ffffff;
      --bg-navigation: #1a6b2e;
      --bg-hero-overlay: linear-gradient(to bottom, rgba(25, 55, 95, 0.3), rgba(25, 55, 95, 0.7));
      --bg-button-green: #1a6b2e;
      --bg-button-hover: #226b38;
      
      /* Border Colors */
      --border-light: #dee2e6;
      --border-medium: #ced4da;
      
      /* Button/Interactive Elements */
      --button-primary-bg: #1a6b2e;
      --button-primary-hover: #226b38;
      --button-primary-text: #ffffff;
      --button-outline-border: #1a6b2e;
      
      /* Icon Colors */
      --icon-green: #1a6b2e;
      --icon-alert: #ffc107;
    }

    /* Custom loading spinner */
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--light-gray);
      border-top: 4px solid var(--primary-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Skeleton loading animation */
    .skeleton {
      background: linear-gradient(90deg, var(--light-gray) 25%, var(--off-white) 50%, var(--light-gray) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Status indicator animations */
    .status-pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Card hover effects */
    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(26, 107, 46, 0.15);
    }

    /* Camera analysis animations */
    .camera-preview {
      transition: all 0.3s ease;
    }

    .analysis-loading {
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .camera-container {
        margin: 0 -1rem;
      }
      
      .camera-preview {
        height: 200px;
      }
    }

    /* Background image styling */
    .app-background {
      background-image: url('/images/sebastian-volkel-7QT_puk5CJQ-unsplash.jpg.webp');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    .app-background::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        135deg,
        rgba(26, 107, 46, 0.85) 0%,
        rgba(25, 55, 95, 0.75) 50%,
        rgba(26, 107, 46, 0.85) 100%
      );
      z-index: 1;
    }

    .app-content {
      position: relative;
      z-index: 2;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
    const { useState, useEffect, useMemo } = React;
    const html = htm.bind(React.createElement);

    const statusStyles = {
      'Not Started': 'bg-gray-100 text-gray-700 border-gray-300',
      'In Progress': 'bg-yellow-100 text-yellow-800 border-yellow-300 status-pulse',
      Completed: 'bg-green-100 text-green-800 border-green-300',
    };

    const statusIcons = {
      'Not Started': '‚è≥',
      'In Progress': 'üîÑ',
      Completed: '‚úÖ',
    };

    function normalizeStatus(value) {
      if (!value) {
        return 'Unknown';
      }

      const normalized = value.trim().toLowerCase();
      switch (normalized) {
        case 'not started':
          return 'Not Started';
        case 'in progress':
        case 'in-progress':
        case 'in progess':
        case 'in proggress':
          return 'In Progress';
        case 'completed':
        case 'complete':
          return 'Completed';
        default:
          return value;
      }
    }

    function StatusBadge({ status = 'Unknown' }) {
      const label = normalizeStatus(status);
      const baseClasses =
        'inline-flex items-center rounded-full px-3 py-1 text-sm font-medium border';
      const variant = statusStyles[label] ?? 'bg-gray-100 text-gray-700 border-gray-300';
      const icon = statusIcons[label] ?? '‚ùì';

      return html`<span className="${baseClasses} ${variant}">
        <span className="mr-2 text-base">${icon}</span>
        ${label}
      </span>`;
    }

    function LoadingSpinner() {
      return html`<div className="flex flex-col items-center justify-center py-8">
        <div className="loading-spinner mb-4"></div>
        <p className="text-sm text-gray-600">Loading collection routes...</p>
      </div>`;
    }

    function SkeletonCard() {
      return html`<div className="animate-pulse">
        <div className="skeleton h-4 w-3/4 mb-2 rounded"></div>
        <div className="skeleton h-3 w-1/2 mb-3 rounded"></div>
        <div className="skeleton h-6 w-20 rounded-full"></div>
      </div>`;
    }

    function SkeletonList() {
      return html`<div className="space-y-3">
        ${Array.from({ length: 5 }, (_, i) => html`<div key=${i} className="p-4 border rounded-lg">
          <${SkeletonCard} />
        </div>`)}
      </div>`;
    }

    function formatDate(value) {
      if (!value) {
        return '--';
      }

      const parsed = new Date(value);
      if (Number.isNaN(parsed.getTime())) {
        return value;
      }

      return new Intl.DateTimeFormat('en-US', { dateStyle: 'medium' }).format(
        parsed
      );
    }

    // Camera Analysis Component
    function CameraAnalysis() {
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      const [analysisResult, setAnalysisResult] = useState(null);
      const [stream, setStream] = useState(null);
      const [error, setError] = useState(null);
      const [videoReady, setVideoReady] = useState(false);
      const videoRef = React.useRef(null);
      const canvasRef = React.useRef(null);
      const playbackCheckRef = React.useRef(null);

      function clearPlaybackMonitor() {
        if (playbackCheckRef.current) {
          clearInterval(playbackCheckRef.current);
          playbackCheckRef.current = null;
        }
      }

      const attachStreamToVideo = (mediaStream) => {
        const videoEl = videoRef.current;
        if (!videoEl) {
          console.warn('Camera preview element is not ready yet.');
          requestAnimationFrame(() => attachStreamToVideo(mediaStream));
          return;
        }

        if (videoEl.srcObject !== mediaStream) {
          videoEl.srcObject = mediaStream;
        }

        const tryPlay = () => {
          const playPromise = videoEl.play();
          if (playPromise && typeof playPromise.then === 'function') {
            playPromise
              .then(() => setVideoReady(true))
              .catch((err) => {
                console.warn('Autoplay blocked, retrying muted playback.', err);
                videoEl.muted = true;
                return videoEl.play().then(
                  () => setVideoReady(true),
                  (innerErr) => {
                    console.error('Video playback failed:', innerErr);
                    setError('Unable to start the camera preview. Please check permissions and try again.');
                    setVideoReady(false);
                  }
                );
              });
          } else {
            setVideoReady(true);
          }
        };

        if (videoEl.readyState >= HTMLMediaElement.HAVE_CURRENT_DATA) {
          tryPlay();
        } else {
          videoEl.addEventListener('loadedmetadata', tryPlay, { once: true });
        }
      };

      const complianceGuidelines = [
        "‚úÖ Leaves should be loose (not bagged)",
        "‚úÖ Pile should be at least 3 feet from street",
        "‚úÖ No branches larger than 3 inches",
        "‚úÖ No trash or debris mixed in",
        "‚úÖ Pile should be manageable size (not too large)"
      ];

      const startCamera = async () => {
        try {
          setError(null);
          setVideoReady(false);
          clearPlaybackMonitor();

          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            setError('Camera access is not supported on this device. Please upload a photo instead.');
            return;
          }

          stopCamera();
          console.log('Requesting camera access...');

          const mediaStream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: { ideal: 'environment' }, // Use back camera on mobile
              width: { ideal: 1280 },
              height: { ideal: 720 }
            },
            audio: false
          });

          console.log('Camera stream obtained:', mediaStream);
          setStream(mediaStream);
          requestAnimationFrame(() => attachStreamToVideo(mediaStream));
        } catch (error) {
          console.error('Camera access denied:', error);
          setError('Camera access is required for pile analysis. Please allow camera access and try again.');
        }
      };

      const stopCamera = () => {
        clearPlaybackMonitor();
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        setStream(null);
        setVideoReady(false);

        const videoEl = videoRef.current;
        if (videoEl) {
          videoEl.pause();
          videoEl.srcObject = null;
        }
      };

      const capturePhoto = () => {
        if (!videoReady) {
          setError('Camera preview is still starting. Please wait a moment and try again.');
          return;
        }

        if (videoRef.current && canvasRef.current) {
          const canvas = canvasRef.current;
          const video = videoRef.current;
          const context = canvas.getContext('2d');
          
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          context.drawImage(video, 0, 0);
          
          const imageData = canvas.toDataURL('image/jpeg', 0.8);
          analyzeImage(imageData);
        }
      };

      const analyzeImage = async (imageData) => {
        setIsAnalyzing(true);
        setAnalysisResult(null);
        
        try {
          // Call the real API endpoint
          const response = await fetch('/api/analyze-pile', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ image: imageData })
          });
          
          if (!response.ok) {
            throw new Error(`Analysis failed: ${response.status}`);
          }
          
          const result = await response.json();
          setAnalysisResult(result);
        } catch (error) {
          console.error('Analysis failed:', error);
          setAnalysisResult({
            compliant: false,
            confidence: 0,
            issues: ["Analysis failed. Please try again."],
            suggestions: ["Please retake the photo and try again."]
          });
        } finally {
          setIsAnalyzing(false);
        }
      };

      const resetAnalysis = () => {
        setAnalysisResult(null);
        setIsAnalyzing(false);
        setError(null);
      };

      React.useEffect(() => {
        return () => {
          stopCamera();
        };
      }, []);

      React.useEffect(() => {
        if (!stream) {
          clearPlaybackMonitor();
          const videoEl = videoRef.current;
          if (videoEl) {
            videoEl.pause();
            videoEl.srcObject = null;
          }
          setVideoReady(false);
          return;
        }

        clearPlaybackMonitor();

        const checkPlayback = () => {
          const videoEl = videoRef.current;
          if (!videoEl) {
            setVideoReady(false);
            return;
          }

          const hasData = videoEl.readyState >= HTMLMediaElement.HAVE_CURRENT_DATA;
          const isPlaying = hasData && !videoEl.paused && !videoEl.ended;

          if (!isPlaying) {
            setVideoReady(false);
            attachStreamToVideo(stream);
          } else {
            setVideoReady(true);
            setError(null);
          }
        };

        requestAnimationFrame(() => attachStreamToVideo(stream));

        const videoEl = videoRef.current;
        if (videoEl) {
          const markReady = () => setVideoReady(true);
          const handleError = (event) => {
            console.error('Video error:', event);
            setVideoReady(false);
          };

          videoEl.addEventListener('playing', markReady);
          videoEl.addEventListener('loadeddata', markReady);
          videoEl.addEventListener('pause', checkPlayback);
          videoEl.addEventListener('stalled', checkPlayback);
          videoEl.addEventListener('suspend', checkPlayback);
          videoEl.addEventListener('error', handleError);

          playbackCheckRef.current = setInterval(checkPlayback, 2000);

          return () => {
            videoEl.removeEventListener('playing', markReady);
            videoEl.removeEventListener('loadeddata', markReady);
            videoEl.removeEventListener('pause', checkPlayback);
            videoEl.removeEventListener('stalled', checkPlayback);
            videoEl.removeEventListener('suspend', checkPlayback);
            videoEl.removeEventListener('error', handleError);
            clearPlaybackMonitor();
            if (videoEl.srcObject === stream) {
              videoEl.srcObject = null;
            }
          };
        }
      }, [stream]);

      return html`
        <div className="space-y-6">
          <div className="bg-gradient-to-r from-blue-50 to-green-50 p-6 rounded-lg border border-blue-200">
            <h3 className="text-lg font-semibold text-gray-900 mb-3 flex items-center">
              <span className="mr-2">üì∏</span>
              Collection Pile Analysis
            </h3>
            <p className="text-sm text-gray-600 mb-4">
              Take a photo of your leaf pile to check if it meets collection guidelines.
            </p>
            
            <div className="space-y-2">
              <h4 className="text-sm font-medium text-gray-700">Collection Guidelines:</h4>
              <ul className="text-xs text-gray-600 space-y-1">
                ${complianceGuidelines.map(guideline => html`
                  <li key=${guideline}>${guideline}</li>
                `)}
              </ul>
            </div>
          </div>

          ${error && html`
            <div className="bg-red-50 border border-red-200 rounded-lg p-4">
              <div className="flex items-center">
                <div className="text-red-500 text-xl mr-3">‚ö†Ô∏è</div>
                <div>
                  <h3 className="text-sm font-medium text-red-800">Camera Error</h3>
                  <p className="text-sm text-red-700 mt-1">${error}</p>
                </div>
              </div>
            </div>
          `}

          ${!stream ? html`
            <div className="text-center py-8">
              <div className="text-4xl mb-4">üì±</div>
              <p className="text-gray-600 mb-4">Ready to analyze your leaf pile?</p>
              <button
                onClick=${startCamera}
                className="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors"
              >
                Start Camera
              </button>
            </div>
          ` : html`
            <div className="space-y-4">
               <div className="relative camera-container">
                 <video
                   ref=${videoRef}
                   autoPlay
                   playsInline
                   muted
                   webkit-playsinline="true"
                   className="w-full h-64 object-cover rounded-lg border border-gray-300 camera-preview"
                   style="background-color: #000; min-height: 256px;"
                   onLoadStart=${() => console.log('Video load started')}
                   onLoadedData=${() => console.log('Video data loaded')}
                   onCanPlay=${() => console.log('Video can play')}
                   onPlay=${() => console.log('Video is playing')}
                 />
                 <canvas ref=${canvasRef} className="hidden" />
                 
                 ${!stream && html`
                   <div className="absolute inset-0 flex items-center justify-center bg-black rounded-lg">
                     <div className="text-center text-white">
                       <div className="text-2xl mb-2">üì∑</div>
                       <p className="text-sm">Camera starting...</p>
                     </div>
                   </div>
                 `}
                 
                 ${stream && !videoReady && html`
                   <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-75 rounded-lg">
                     <div className="text-center text-white space-y-1">
                       <div className="loading-spinner mb-2 mx-auto"></div>
                       <p className="text-sm">Loading camera feed...</p>
                       <p className="text-xs text-gray-200">If the preview stays blank, check camera permissions and try again.</p>
                     </div>
                   </div>
                 `}
                
                <div className="absolute top-4 right-4">
                  <button
                    onClick=${stopCamera}
                    className="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors shadow-lg"
                    title="Close camera"
                  >
                    ‚úï
                  </button>
                </div>
                
                ${isAnalyzing && html`
                  <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-lg">
                    <div className="text-center text-white">
                      <div className="loading-spinner mb-2 mx-auto"></div>
                      <p className="text-sm">Analyzing your pile...</p>
                    </div>
                  </div>
                `}
              </div>

              <div className="flex gap-3">
                <button
                  onClick=${capturePhoto}
                  disabled=${isAnalyzing}
                  className="flex-1 bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                  ${isAnalyzing ? 'Analyzing...' : 'üì∏ Capture & Analyze'}
                </button>
                <button
                  onClick=${resetAnalysis}
                  className="px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                >
                  Reset
                </button>
              </div>
            </div>
          `}

          ${analysisResult && html`
            <div className=${`p-6 rounded-lg border-2 ${
              analysisResult.compliant 
                ? 'bg-green-50 border-green-200' 
                : 'bg-red-50 border-red-200'
            }`}>
              <div className="flex items-center mb-4">
                <div className="text-2xl mr-3">
                  ${analysisResult.compliant ? '‚úÖ' : '‚ùå'}
                </div>
                <div>
                  <h4 className="text-lg font-semibold ${
                    analysisResult.compliant ? 'text-green-800' : 'text-red-800'
                  }">
                    ${analysisResult.compliant ? 'Pile Looks Good!' : 'Issues Found'}
                  </h4>
                  <p className="text-sm text-gray-600">
                    Confidence: ${analysisResult.confidence}%
                  </p>
                </div>
              </div>

              ${analysisResult.issues.length > 0 && html`
                <div className="mb-4">
                  <h5 className="font-medium text-red-700 mb-2">Issues Found:</h5>
                  <ul className="text-sm text-red-600 space-y-1">
                    ${analysisResult.issues.map(issue => html`
                      <li key=${issue}>‚Ä¢ ${issue}</li>
                    `)}
                  </ul>
                </div>
              `}

              <div>
                <h5 className="font-medium text-gray-700 mb-2">Suggestions:</h5>
                <ul className="text-sm text-gray-600 space-y-1">
                  ${analysisResult.suggestions.map(suggestion => html`
                    <li key=${suggestion}>‚Ä¢ ${suggestion}</li>
                  `)}
                </ul>
              </div>
            </div>
          `}
        </div>
      `;
    }

    function App() {
      const [records, setRecords] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [activeId, setActiveId] = useState(null);
      const [sortBy, setSortBy] = useState('street');
      const [showCamera, setShowCamera] = useState(false);

      useEffect(() => {
        let isMounted = true;

        async function loadData() {
          try {
            const response = await fetch('/api/streets');
            if (!response.ok) {
              throw new Error('Unable to fetch street data.');
            }

            const payload = await response.json();
            if (isMounted) {
              setRecords(Array.isArray(payload.records) ? payload.records : []);
            }
          } catch (err) {
            console.error(err);
            if (isMounted) {
              setError(
                'Unable to load the latest collection information right now. Please try again soon.'
              );
            }
          } finally {
            if (isMounted) {
              setLoading(false);
            }
          }
        }

        loadData();

        return () => {
          isMounted = false;
        };
      }, []);

      const sortedRecords = useMemo(() => {
        const filtered = [...records].filter((record) => Boolean(record.street));
        
        return filtered.sort((a, b) => {
          switch (sortBy) {
            case 'status':
              const statusOrder = { 'Not Started': 0, 'In Progress': 1, 'Completed': 2 };
              const aStatus = normalizeStatus(a.status || 'Unknown');
              const bStatus = normalizeStatus(b.status || 'Unknown');
              const aOrder = statusOrder[aStatus] ?? 3;
              const bOrder = statusOrder[bStatus] ?? 3;
              if (aOrder !== bOrder) return aOrder - bOrder;
              return a.street.localeCompare(b.street);
            case 'route':
              const aRoute = parseInt(a.routeNumber) || 999;
              const bRoute = parseInt(b.routeNumber) || 999;
              if (aRoute !== bRoute) return aRoute - bRoute;
              return a.street.localeCompare(b.street);
            case 'street':
            default:
              return a.street.localeCompare(b.street);
          }
        });
      }, [records, sortBy]);

      const filteredRecords = useMemo(() => {
        const term = searchTerm.trim().toLowerCase();
        if (!term) {
          return sortedRecords;
        }

        return sortedRecords.filter((record) =>
          record.street.toLowerCase().includes(term)
        );
      }, [sortedRecords, searchTerm]);

      useEffect(() => {
        if (!activeId && filteredRecords.length > 0) {
          setActiveId(filteredRecords[0].id);
        }
      }, [filteredRecords, activeId]);

      const selectedRecord = useMemo(() => {
        if (!activeId) {
          return null;
        }

        return records.find((record) => record.id === activeId) ?? null;
      }, [records, activeId]);

      let mainContent;

      if (loading) {
        mainContent = html`<div className="mt-8">
          <${LoadingSpinner} />
        </div>`;
      } else if (error) {
        mainContent = html`<div className="mt-8 rounded-lg bg-red-50 border border-red-200 p-6">
          <div className="flex items-center">
            <div className="text-red-500 text-xl mr-3">‚ö†Ô∏è</div>
            <div>
              <h3 className="text-sm font-medium text-red-800">Unable to load data</h3>
              <p className="text-sm text-red-700 mt-1">${error}</p>
            </div>
          </div>
        </div>`;
      } else {
        const resultsList =
          filteredRecords.length === 0
            ? html`<div className="p-6 text-center">
                <div className="text-4xl mb-3">üîç</div>
                <p className="text-sm text-gray-500">
                  No streets match that search. Try another name or double-check your spelling.
                </p>
              </div>`
            : html`<ul className="divide-y divide-gray-200">
                ${filteredRecords.map((record) => {
                  const isActive = record.id === activeId;
                  return html`<li key=${record.id}>
                    <button
                      type="button"
                      onClick=${() => setActiveId(record.id)}
                      className=${`flex w-full items-center justify-between px-4 py-4 text-left transition-all duration-200 card-hover ${
                        isActive 
                          ? 'bg-green-50 border-l-4 border-l-green-500 shadow-sm' 
                          : 'hover:bg-gray-50 hover:border-l-4 hover:border-l-gray-300'
                      }`}
                    >
                      <div className="flex-1">
                        <p className="font-medium text-gray-900">${record.street}</p>
                        <p className="text-sm text-gray-500 mt-1">
                          Route ${record.routeNumber || '--'}
                        </p>
                      </div>
                      <${StatusBadge} status=${record.status || 'Unknown'} />
                    </button>
                  </li>`;
                })}
              </ul>`;

        const detailBody = selectedRecord
          ? html`<div className="space-y-4">
              <div className="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-lg font-semibold text-green-800">${selectedRecord.street}</h3>
                  <${StatusBadge} status=${selectedRecord.status || 'Unknown'} />
                </div>
                <p className="text-sm text-green-700">Route ${selectedRecord.routeNumber || '--'}</p>
              </div>
              
              <dl className="space-y-3">
                <div className="flex items-center justify-between py-2 border-b border-gray-100">
                  <dt className="text-sm font-medium text-gray-600 flex items-center">
                    <span className="mr-2">üìÖ</span>
                    Date Started
                  </dt>
                  <dd className="text-sm font-medium text-gray-900">
                    ${formatDate(selectedRecord.dateStarted)}
                  </dd>
                </div>
                <div className="flex items-center justify-between py-2 border-b border-gray-100">
                  <dt className="text-sm font-medium text-gray-600 flex items-center">
                    <span className="mr-2">‚úÖ</span>
                    Date Completed
                  </dt>
                  <dd className="text-sm font-medium text-gray-900">
                    ${formatDate(selectedRecord.dateCompleted)}
                  </dd>
                </div>
              </dl>
            </div>`
          : filteredRecords.length === 0
          ? html`<div className="text-center py-8">
              <div className="text-4xl mb-3">üè†</div>
              <p className="text-sm text-gray-500">
                Start typing to find your street and see its pickup details.
              </p>
            </div>`
          : html`<div className="text-center py-8">
              <div className="text-4xl mb-3">üìç</div>
              <p className="text-sm text-gray-500">
                Select a street from the list to view its route and collection dates.
              </p>
            </div>`;

        mainContent = html`<div className="mt-8 grid gap-6 lg:grid-cols-[2fr,3fr]">
          <section aria-label="Street results" className="space-y-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-2">
                <span className="text-sm font-medium text-gray-600">
                  ${filteredRecords.length} ${filteredRecords.length === 1 ? 'result' : 'results'}
                </span>
                ${filteredRecords.length > 0 ? html`<span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  ${filteredRecords.filter(r => r.status === 'Completed').length} completed
                </span>` : null}
              </div>
              <div className="flex items-center space-x-3">
                <div className="flex items-center space-x-2">
                  <label htmlFor="sort-select" className="text-sm font-medium text-gray-600 flex items-center">
                    <span className="mr-1">üîÄ</span>
                    Sort by:
                  </label>
                  <select
                    id="sort-select"
                    value=${sortBy}
                    onChange=${(e) => setSortBy(e.target.value)}
                    className="text-sm border border-gray-300 rounded-md px-3 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 hover:border-green-400 transition-colors"
                  >
                    <option value="street">Street Name</option>
                    <option value="status">Status</option>
                    <option value="route">Route Number</option>
                  </select>
                </div>
                ${searchTerm
                  ? html`<button
                      type="button"
                      onClick=${() => {
                        setSearchTerm('');
                        setActiveId(null);
                      }}
                      className="text-sm text-green-600 hover:text-green-700 font-medium"
                    >
                      Clear search
                    </button>`
                  : null}
              </div>
            </div>
            <div className="max-h-96 overflow-y-auto rounded-lg border border-gray-200 bg-white/90 backdrop-blur-sm shadow-sm">
              ${resultsList}
            </div>
          </section>

          <section aria-live="polite" aria-label="Street details" className="space-y-4">
            <div className="rounded-lg border border-gray-200 bg-white/90 backdrop-blur-sm p-6 shadow-sm">
              <h2 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <span className="mr-2">üìã</span>
                Collection Details
              </h2>
              ${detailBody}
            </div>
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <p className="text-xs text-blue-700 flex items-center">
                <span className="mr-2">‚ÑπÔ∏è</span>
                This information reflects the most recent update from the Westlake Service Department.
              </p>
            </div>
          </section>
        </div>`;
      }

      return html`<div className="min-h-screen app-background px-4 py-10">
        <div className="mx-auto flex max-w-6xl flex-col gap-8 app-content">
          <header className="text-center">
            <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg p-8 border border-green-200">
              <div className="flex items-center justify-center mb-4">
                <div className="text-4xl mr-3">üçÇ</div>
                <h1 className="text-4xl font-bold text-green-800">
                  Westlake Leaf Collection Tracker
                </h1>
              </div>
              <p className="text-lg text-gray-600 mb-4">
                Search your street to see the latest pickup status
              </p>
              <div className="flex gap-3 justify-center mb-2">
                <button
                  onClick=${() => setShowCamera(!showCamera)}
                  className="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center"
                >
                  <span className="mr-2">üì∏</span>
                  ${showCamera ? 'Hide' : 'Analyze'} My Pile
                </button>
              </div>
              <p className="text-sm text-gray-500">
                Updated daily by the Westlake Service Department
              </p>
            </div>
          </header>

          ${showCamera ? html`
            <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200 p-6 mb-6">
              <${CameraAnalysis} />
            </div>
          ` : null}

          <main className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
            <div className="bg-gradient-to-r from-green-600 to-green-700 px-6 py-4">
              <div className="flex flex-col gap-4">
                <label className="text-sm font-medium text-white flex items-center" htmlFor="street-search">
                  <span className="mr-2">üîç</span>
                  Search for your street
                </label>
                <input
                  id="street-search"
                  type="search"
                  placeholder="Start typing to find your street..."
                  value=${searchTerm}
                  onChange=${(event) => setSearchTerm(event.target.value)}
                  className="w-full rounded-lg border-0 px-4 py-3 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 bg-white text-gray-900 placeholder-gray-500"
                />
              </div>
            </div>
            
            <div className="p-6">
              ${mainContent}
            </div>
          </main>
        </div>
      </div>`;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(html`<${App} />`);
  </script>
</body>
</html>
