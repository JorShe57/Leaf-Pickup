<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Westlake Leaf Collection Tracker</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Track leaf collection routes and schedules for Westlake. Check your street's pickup status and analyze your leaf pile.">
  <meta name="theme-color" content="#1a6b2e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Leaf Tracker">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Icons for iOS -->
  <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png">
  <link rel="apple-touch-icon" sizes="128x128" href="/icons/icon-128x128.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png">
  <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-152x152.png">
  
  <!-- Preload critical resources -->
  <link rel="preload" href="/images/sebastian-volkel-7QT_puk5CJQ-unsplash.jpg.webp" as="image">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
  <script src="https://unpkg.com/gsap@3.12.2/dist/gsap.min.js"></script>
  <style>
    :root {
      /* Primary Colors */
      --primary-green: #1a6b2e;
      --primary-green-dark: #145523;
      --primary-green-hover: #226b38;
      
      /* Accent Colors */
      --accent-blue-overlay: rgba(25, 55, 95, 0.65);
      --accent-gold: #d4af37;
      
      /* Neutral Colors */
      --white: #ffffff;
      --off-white: #f8f9fa;
      --light-gray: #e8e9eb;
      --medium-gray: #6c757d;
      --dark-gray: #343a40;
      --black: #000000;
      
      /* Text Colors */
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --text-on-green: #ffffff;
      --text-on-dark: #ffffff;
      
      /* Background Colors */
      --bg-primary: #ffffff;
      --bg-navigation: #1a6b2e;
      --bg-hero-overlay: linear-gradient(to bottom, rgba(25, 55, 95, 0.3), rgba(25, 55, 95, 0.7));
      --bg-button-green: #1a6b2e;
      --bg-button-hover: #226b38;
      
      /* Border Colors */
      --border-light: #dee2e6;
      --border-medium: #ced4da;
      
      /* Button/Interactive Elements */
      --button-primary-bg: #1a6b2e;
      --button-primary-hover: #226b38;
      --button-primary-text: #ffffff;
      --button-outline-border: #1a6b2e;
      
      /* Icon Colors */
      --icon-green: #1a6b2e;
      --icon-alert: #ffc107;
    }

    /* Custom loading spinner */
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--light-gray);
      border-top: 4px solid var(--primary-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Skeleton loading animation */
    .skeleton {
      background: linear-gradient(90deg, var(--light-gray) 25%, var(--off-white) 50%, var(--light-gray) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Status indicator animations */
    .status-pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Card hover effects */
    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(26, 107, 46, 0.15);
    }

    /* Camera analysis animations */
    .camera-preview {
      transition: all 0.3s ease;
    }

    .analysis-loading {
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Mobile optimizations and touch improvements */
    * {
      -webkit-tap-highlight-color: rgba(26, 107, 46, 0.2);
      touch-action: manipulation;
    }
    
    /* Safe area support for notched devices */
    body {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    
    /* Better scrolling on mobile */
    .scroll-container {
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    
    /* Touch target improvements - minimum 44x44px */
    button, a, input, select {
      min-height: 44px;
      touch-action: manipulation;
    }
    
    /* Active state feedback for touch */
    button:active, .card-hover:active {
      transform: scale(0.98);
      transition: transform 0.1s ease;
    }
    
    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Mobile-specific styles */
    @media (max-width: 768px) {
      .camera-container {
        margin: 0 -1rem;
      }
      
      .camera-preview {
        height: 200px;
      }
      
      /* Hide desktop-only elements */
      .desktop-only {
        display: none !important;
      }
      
      /* Stack layout on mobile */
      .mobile-stack {
        grid-template-columns: 1fr !important;
      }
      
      /* Larger text for readability */
      body {
        font-size: 16px;
      }
      
      /* Better spacing on mobile */
      .mobile-spacing {
        padding: 0.75rem !important;
      }
      
      /* Full width buttons on mobile */
      .mobile-full-button {
        width: 100%;
      }
    }

    /* Background image styling */
    .app-background {
      background-image: url('/images/sebastian-volkel-7QT_puk5CJQ-unsplash.jpg.webp');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    .app-background::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        135deg,
        rgba(26, 107, 46, 0.85) 0%,
        rgba(25, 55, 95, 0.75) 50%,
        rgba(26, 107, 46, 0.85) 100%
      );
      z-index: 1;
    }

    .app-content {
      position: relative;
      z-index: 2;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
    const { useState, useEffect, useMemo } = React;
    const html = htm.bind(React.createElement);

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('/sw.js')
          .then((registration) => {
            console.log('[PWA] Service Worker registered:', registration.scope);
            
            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New update available
                  if (confirm('A new version is available! Reload to update?')) {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch((error) => {
            console.error('[PWA] Service Worker registration failed:', error);
          });
      });
      
      // Handle controller change (new service worker activated)
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        console.log('[PWA] Service Worker controller changed');
      });
    }

    // Install Prompt Handler
    let deferredPrompt = null;
    let installPromptShown = false;

    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('[PWA] Install prompt available');
      e.preventDefault();
      deferredPrompt = e;
      
      // Show install button (will be handled in React component)
      window.dispatchEvent(new CustomEvent('pwa-installable', { detail: { prompt: e } }));
    });

    window.addEventListener('appinstalled', () => {
      console.log('[PWA] App installed successfully');
      deferredPrompt = null;
    });

    // Function to show install prompt
    async function showInstallPrompt() {
      if (!deferredPrompt) {
        // Check if already installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
          alert('App is already installed!');
          return false;
        }
        
        // Show iOS instructions
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        
        if (isIOS || isSafari) {
          alert('To install on iOS:\n\n1. Tap the Share button (box with arrow)\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" to confirm');
          return false;
        }
        
        return false;
      }
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('[PWA] Install prompt outcome:', outcome);
      
      if (outcome === 'accepted') {
        deferredPrompt = null;
        return true;
      }
      
      return false;
    }

    // Check if running as installed PWA
    function isInstalled() {
      return window.matchMedia('(display-mode: standalone)').matches || 
             window.navigator.standalone === true;
    }

    const statusStyles = {
      'Not Started': 'bg-gray-100 text-gray-700 border-gray-300',
      'In Progress': 'bg-yellow-100 text-yellow-800 border-yellow-300 status-pulse',
      Completed: 'bg-green-100 text-green-800 border-green-300',
    };

    const statusIcons = {
      'Not Started': '‚è≥',
      'In Progress': 'üîÑ',
      Completed: '‚úÖ',
    };

    function normalizeStatus(value) {
      if (!value) {
        return 'Unknown';
      }

      const normalized = value.trim().toLowerCase();
      switch (normalized) {
        case 'not started':
          return 'Not Started';
        case 'in progress':
        case 'in-progress':
        case 'in progess':
        case 'in proggress':
          return 'In Progress';
        case 'completed':
        case 'complete':
          return 'Completed';
        default:
          return value;
      }
    }

    function StatusBadge({ status = 'Unknown' }) {
      const label = normalizeStatus(status);
      const baseClasses =
        'inline-flex items-center rounded-full px-3 py-1 text-sm font-medium border';
      const variant = statusStyles[label] ?? 'bg-gray-100 text-gray-700 border-gray-300';
      const icon = statusIcons[label] ?? '‚ùì';

      return html`<span className="${baseClasses} ${variant}">
        <span className="mr-2 text-base">${icon}</span>
        ${label}
      </span>`;
    }

    function LoadingSpinner() {
      return html`<div className="flex flex-col items-center justify-center py-8">
        <div className="loading-spinner mb-4"></div>
        <p className="text-sm text-gray-600">Loading collection routes...</p>
      </div>`;
    }

    function SkeletonCard() {
      return html`<div className="animate-pulse">
        <div className="skeleton h-4 w-3/4 mb-2 rounded"></div>
        <div className="skeleton h-3 w-1/2 mb-3 rounded"></div>
        <div className="skeleton h-6 w-20 rounded-full"></div>
      </div>`;
    }

    function SkeletonList() {
      return html`<div className="space-y-3">
        ${Array.from({ length: 5 }, (_, i) => html`<div key=${i} className="p-4 border rounded-lg">
          <${SkeletonCard} />
        </div>`)}
      </div>`;
    }

    function ProgressBar({ progress, label }) {
      return html`<div className="w-full bg-gray-200 rounded-full h-2 mb-2">
        <div 
          className="bg-green-600 h-2 rounded-full transition-all duration-300 ease-out"
          style="width: ${progress}%"
        ></div>
      </div>
      <p className="text-sm text-gray-600 text-center">${label}</p>`;
    }

    function RouteModal({ record, isOpen, onClose }) {
      if (!isOpen || !record) return null;

      return html`
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between p-4 border-b border-gray-200">
              <h3 className="text-lg font-semibold text-gray-900">Route Details</h3>
              <button
                onClick=${onClose}
                className="text-gray-400 hover:text-gray-600 transition-colors"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            
            <div className="p-4 space-y-4">
              <div className="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                <div className="flex items-center justify-between mb-2">
                  <h4 className="text-lg font-semibold text-green-800">${record.street}</h4>
                  <${StatusBadge} status=${record.status || 'Unknown'} />
                </div>
                <p className="text-sm text-green-700">Route ${record.routeNumber || '--'}</p>
              </div>
              
              <div className="space-y-3">
                <div className="flex items-center justify-between py-2 border-b border-gray-100">
                  <dt className="text-sm font-medium text-gray-600 flex items-center">
                    <span className="mr-2">üìÖ</span>
                    Date Started
                  </dt>
                  <dd className="text-sm font-medium text-gray-900">
                    ${formatDate(record.dateStarted)}
                  </dd>
                </div>
                
                <div className="flex items-center justify-between py-2 border-b border-gray-100">
                  <dt className="text-sm font-medium text-gray-600 flex items-center">
                    <span className="mr-2">‚úÖ</span>
                    Date Completed
                  </dt>
                  <dd className="text-sm font-medium text-gray-900">
                    ${formatDate(record.dateCompleted)}
                  </dd>
                </div>
                
                ${record.notes && record.notes.trim() && html`
                  <div className="py-2">
                    <dt className="text-sm font-medium text-gray-600 flex items-center mb-2">
                      <span className="mr-2">üìù</span>
                      Notes
                    </dt>
                    <dd className="text-sm text-gray-900 bg-gray-50 p-3 rounded-lg border">
                      ${record.notes}
                    </dd>
                  </div>
                `}
              </div>
              
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <p className="text-xs text-blue-700 flex items-center">
                  <span className="mr-2">‚ÑπÔ∏è</span>
                  This information reflects the most recent update from the Westlake Service Department.
                </p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function formatReportContent(content) {
      if (!content) return '';
      
      // Convert markdown-like formatting to HTML
      let formatted = content
        // Convert headers
        .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">$1</h3>')
        .replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold text-gray-900 mt-6 mb-3">$1</h2>')
        .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold text-gray-900 mt-6 mb-4">$1</h1>')
        
        // Convert bold text
        .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-gray-800">$1</strong>')
        
        // Convert bullet points
        .replace(/^- (.*$)/gim, '<li class="ml-4 mb-1">‚Ä¢ $1</li>')
        .replace(/^  - (.*$)/gim, '<li class="ml-8 mb-1">‚Ä¢ $1</li>')
        
        // Convert status indicators
        .replace(/‚úÖ/g, '<span class="text-green-600 font-bold">‚úÖ</span>')
        .replace(/‚ùå/g, '<span class="text-red-600 font-bold">‚ùå</span>')
        .replace(/‚õî/g, '<span class="text-orange-600 font-bold">‚õî</span>')
        
        // Convert horizontal rules
        .replace(/^---$/gim, '<hr class="my-4 border-gray-300">')
        
        // Convert line breaks
        .replace(/\n/g, '<br>');
      
      // Wrap lists in ul tags
      formatted = formatted.replace(/(<li.*<\/li>)/g, '<ul class="list-none space-y-1">$1</ul>');
      
      return html`<div dangerouslySetInnerHTML=${{__html: formatted}}></div>`;
    }

    function formatDate(value) {
      if (!value) {
        return '--';
      }

      const parsed = new Date(value);
      if (Number.isNaN(parsed.getTime())) {
        return value;
      }

      return new Intl.DateTimeFormat('en-US', { dateStyle: 'medium' }).format(
        parsed
      );
    }

    // Install Prompt Banner Component
    function InstallPrompt() {
      const [showPrompt, setShowPrompt] = useState(false);
      const [isInstalled, setIsInstalled] = useState(false);

      useEffect(() => {
        // Check if already installed
        setIsInstalled(
          window.matchMedia('(display-mode: standalone)').matches || 
          window.navigator.standalone === true
        );

        // Listen for install prompt availability
        const handleInstallable = () => {
          if (!isInstalled) {
            setShowPrompt(true);
          }
        };

        window.addEventListener('pwa-installable', handleInstallable);
        
        // Check immediately if prompt is available
        if (deferredPrompt && !isInstalled) {
          setShowPrompt(true);
        }

        return () => {
          window.removeEventListener('pwa-installable', handleInstallable);
        };
      }, []);

      const handleInstall = async () => {
        const success = await showInstallPrompt();
        if (success) {
          setShowPrompt(false);
          setIsInstalled(true);
        }
      };

      const handleDismiss = () => {
        setShowPrompt(false);
      };

      if (isInstalled) {
        return null;
      }

      if (!showPrompt) {
        return null;
      }

      return html`
        <div className="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-green-600 to-green-700 text-white p-4 shadow-lg z-50 border-t-4 border-green-400" style="padding-bottom: calc(1rem + env(safe-area-inset-bottom))">
          <div className="max-w-4xl mx-auto flex items-center justify-between gap-4">
            <div className="flex items-center flex-1">
              <span className="text-2xl mr-3">üçÇ</span>
              <div>
                <p className="font-semibold text-sm">Install Leaf Tracker</p>
                <p className="text-xs opacity-90">Get quick access from your home screen</p>
              </div>
            </div>
            <div className="flex gap-2">
              <button
                onClick=${handleInstall}
                className="bg-white text-green-700 px-4 py-2 rounded-lg font-medium text-sm hover:bg-green-50 transition-colors whitespace-nowrap"
              >
                Install
              </button>
              <button
                onClick=${handleDismiss}
                className="text-white hover:bg-green-800 px-3 py-2 rounded-lg transition-colors"
                aria-label="Dismiss"
              >
                ‚úï
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Camera Analysis Component (file upload to n8n workflow)
    function CameraAnalysis() {
      const [selectedFile, setSelectedFile] = useState(null);
      const [previewUrl, setPreviewUrl] = useState(null);
      const [analysisResult, setAnalysisResult] = useState(null);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [error, setError] = useState(null);
      const [isProcessingImage, setIsProcessingImage] = useState(false);
      const [payloadImage, setPayloadImage] = useState(null);
      const [uploadMeta, setUploadMeta] = useState(null);
      const [analysisProgress, setAnalysisProgress] = useState(0);
      const [progressLabel, setProgressLabel] = useState('');
      const fileInputRef = React.useRef(null);

      const complianceGuidelines = [
        "‚úÖ Leaves should be loose (not bagged)",
        "‚úÖ Keep piles at least 3 feet from the curb",
        "‚úÖ Remove branches larger than 3 inches",
        "‚úÖ No trash or debris mixed in",
        "‚úÖ Pile should be a manageable size"
      ];

      const estimateSizeKb = (dataUrl) => {
        const base64 = dataUrl.split(',')[1] || '';
        return Math.round((base64.length * 0.75) / 1024);
      };

      const compressImage = (file) => {
        return new Promise((resolve, reject) => {
          const objectUrl = URL.createObjectURL(file);
          const image = new Image();
          image.onload = () => {
            try {
              const maxDimension = 1280;
              let { width, height } = image;
              const scale = Math.min(1, maxDimension / Math.max(width, height));
              const targetWidth = Math.round(width * scale);
              const targetHeight = Math.round(height * scale);

              const canvas = document.createElement('canvas');
              canvas.width = targetWidth;
              canvas.height = targetHeight;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(image, 0, 0, targetWidth, targetHeight);
              const dataUrl = canvas.toDataURL('image/jpeg', 0.82);

              URL.revokeObjectURL(objectUrl);

              resolve({
                dataUrl,
                width: targetWidth,
                height: targetHeight,
                sizeKb: estimateSizeKb(dataUrl),
              });
            } catch (err) {
              reject(err);
            }
          };
          image.onerror = () => {
            URL.revokeObjectURL(objectUrl);
            reject(new Error('Unable to read the selected image.'));
          };
          image.src = objectUrl;
        });
      };

      const handleFileChange = async (event) => {
        const file = event.target.files && event.target.files[0];
        if (!file) {
          return;
        }

        if (!file.type.startsWith('image/')) {
          setError('Please upload an image file (JPEG or PNG).');
          setSelectedFile(null);
          setPreviewUrl(null);
          setPayloadImage(null);
          setUploadMeta(null);
          return;
        }

        setIsProcessingImage(true);
        setError(null);
        setAnalysisResult(null);
        setPayloadImage(null);
        setUploadMeta(null);

        try {
          const compressed = await compressImage(file);
          setSelectedFile(file);
          setPreviewUrl(compressed.dataUrl);
          setPayloadImage(compressed.dataUrl);
          setUploadMeta({
            sizeKb: compressed.sizeKb,
            width: compressed.width,
            height: compressed.height,
          });
        } catch (err) {
          console.error('Image compression failed:', err);
          setError('We were unable to process that image. Please try a different photo.');
          setSelectedFile(null);
          setPreviewUrl(null);
          setPayloadImage(null);
          setUploadMeta(null);
        } finally {
          setIsProcessingImage(false);
        }
      };

      const handleSelectClick = () => {
        if (fileInputRef.current) {
          fileInputRef.current.value = null;
          fileInputRef.current.click();
        }
      };

      const submitForAnalysis = async () => {
        if (!payloadImage) {
          setError('Add a photo before requesting analysis.');
          return;
        }

        setIsSubmitting(true);
        setError(null);
        setAnalysisResult(null);
        setAnalysisProgress(0);
        setProgressLabel('Preparing analysis...');

        // Simulate progress updates
        const progressInterval = setInterval(() => {
          setAnalysisProgress(prev => {
            if (prev < 90) {
              const newProgress = prev + Math.random() * 15;
              if (newProgress < 30) {
                setProgressLabel('Sending image to AI...');
              } else if (newProgress < 60) {
                setProgressLabel('AI analyzing your pile...');
              } else if (newProgress < 90) {
                setProgressLabel('Generating compliance report...');
              }
              return Math.min(newProgress, 90);
            }
            return prev;
          });
        }, 500);

        try {
          const response = await fetch('/api/analyze-pile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              image: payloadImage,
              filename: selectedFile ? selectedFile.name : 'leaf-pile.jpg',
            }),
          });

          if (!response.ok) {
            const error = new Error('Analysis request failed');
            error.status = response.status;
            throw error;
          }

          const result = await response.json();
          
          // Complete progress
          clearInterval(progressInterval);
          setAnalysisProgress(100);
          setProgressLabel('Analysis complete!');
          
          // Small delay to show completion
          setTimeout(() => {
            setAnalysisResult(result);
            setIsSubmitting(false);
          }, 500);
          
        } catch (err) {
          clearInterval(progressInterval);
          console.error('Analysis request failed:', err);
          if (err && err.status === 413) {
            setError('The photo was too large to send to the analyzer. Try retaking it from a little farther back or using a lower-resolution photo.');
          } else {
            setError('We could not reach the analysis service. Please try again in a moment.');
          }
          setIsSubmitting(false);
        }
      };

      const resetUpload = () => {
        setSelectedFile(null);
        setPreviewUrl(null);
        setAnalysisResult(null);
        setError(null);
        setPayloadImage(null);
        setUploadMeta(null);
        if (fileInputRef.current) {
          fileInputRef.current.value = null;
        }
      };

      return html`
        <div className="space-y-6">
          <div className="bg-gradient-to-r from-blue-50 to-green-50 p-6 rounded-lg border border-blue-200">
            <h3 className="text-lg font-semibold text-gray-900 mb-3 flex items-center">
              <span className="mr-2">üì∏</span>
              Collection Pile Analysis
            </h3>
            <p className="text-sm text-gray-600 mb-4">
              Snap a photo of your leaf pile and upload it. Our n8n automation will review the image and send back guidance.
            </p>
            
            <div className="space-y-2">
              <h4 className="text-sm font-medium text-gray-700">Collection Guidelines:</h4>
              <ul className="text-xs text-gray-600 space-y-1">
                ${complianceGuidelines.map(guideline => html`
                  <li key=${guideline}>${guideline}</li>
                `)}
              </ul>
            </div>
          </div>

          ${error && html`
            <div className="bg-red-50 border border-red-200 rounded-lg p-4">
              <div className="flex items-center">
                <div className="text-red-500 text-xl mr-3">‚ö†Ô∏è</div>
                <div>
                  <h3 className="text-sm font-medium text-red-800">Upload Error</h3>
                  <p className="text-sm text-red-700 mt-1">${error}</p>
                </div>
              </div>
            </div>
          `}

          <div className="space-y-4">
            <input
              type="file"
              accept="image/*"
              capture="environment"
              ref=${fileInputRef}
              onChange=${handleFileChange}
              className="hidden"
            />

            <div
              className=${`border-2 border-dashed rounded-lg p-6 text-center transition ${previewUrl ? 'border-green-300 bg-green-50' : 'border-gray-300 hover:border-green-400'}`}
            >
              ${previewUrl ? html`
                <div className="space-y-3">
                  <img
                    src=${previewUrl}
                    alt="Leaf pile preview"
                    className="w-full rounded-md max-h-64 object-cover border border-green-200"
                  />
                  <p className="text-sm text-gray-600">
                    ${selectedFile ? selectedFile.name : 'leaf-pile.jpg'}
                  </p>
                  ${uploadMeta && html`
                    <p className="text-xs text-gray-500">
                      Optimized to ${uploadMeta.width}√ó${uploadMeta.height}px (~${uploadMeta.sizeKb} KB)
                    </p>
                  `}
                  <div className="flex justify-center gap-3">
                    <button
                      onClick=${handleSelectClick}
                      className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition"
                    >
                      Choose another photo
                    </button>
                    <button
                      onClick=${resetUpload}
                      className="px-4 py-2 bg-white border border-gray-300 text-gray-600 rounded-md hover:bg-gray-100 transition"
                    >
                      Remove
                    </button>
                  </div>
                </div>
              ` : html`
                <div className="space-y-3">
                  <div className="text-4xl">üì∑</div>
                  <p className="text-sm text-gray-600">
                    Tap below to snap a new photo or upload one from your device.
                  </p>
                  <button
                    onClick=${handleSelectClick}
                    className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition"
                  >
                    Select Photo
                  </button>
                  <p className="text-xs text-gray-500">
                    Works on mobile and desktop. On mobile, your camera app will open automatically.
                  </p>
                </div>
              `}
            </div>

            <button
              onClick=${submitForAnalysis}
              disabled=${isSubmitting || isProcessingImage || !payloadImage}
              className="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              ${isProcessingImage
                ? 'Optimizing photo...'
                : isSubmitting
                  ? 'Submitting to n8n...'
                  : 'Send to Analysis'}
            </button>
            
            ${isSubmitting && html`
              <div className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div className="flex items-center mb-3">
                  <div className="loading-spinner mr-3"></div>
                  <span className="text-sm font-medium text-blue-800">AI Analysis in Progress</span>
                </div>
                <${ProgressBar} progress=${analysisProgress} label=${progressLabel} />
              </div>
            `}
          </div>

          ${analysisResult && html`
            <div className=${`p-6 rounded-lg border-2 ${
              analysisResult.compliant 
                ? 'bg-green-50 border-green-200' 
                : 'bg-red-50 border-red-200'
            }`}>
              <div className="flex items-center mb-4">
                <div className="text-2xl mr-3">
                  ${analysisResult.compliant ? '‚úÖ' : '‚ùå'}
                </div>
                <div>
                  <h4 className="text-lg font-semibold ${
                    analysisResult.compliant ? 'text-green-800' : 'text-red-800'
                  }">
                    ${analysisResult.compliant ? 'Ready for Pickup!' : 'Issues Found'}
                  </h4>
                  ${analysisResult.confidence !== undefined && html`
                    <p className="text-sm text-gray-600">
                      Confidence: ${analysisResult.confidence}%
                    </p>
                  `}
                </div>
              </div>

              ${analysisResult.reportContent ? html`
                <div className="bg-white rounded-lg p-4 border border-gray-200">
                  <h5 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <span className="mr-2">üìã</span>
                    AI Analysis Report
                  </h5>
                  <div className="prose prose-sm max-w-none">
                    ${formatReportContent(analysisResult.reportContent)}
                  </div>
                </div>
              ` : html`
                ${Array.isArray(analysisResult.issues) && analysisResult.issues.length > 0 && html`
                  <div className="mb-4">
                    <h5 className="font-medium text-red-700 mb-2">Issues Found:</h5>
                    <ul className="text-sm text-red-600 space-y-1">
                      ${analysisResult.issues.map(issue => html`
                        <li key=${issue}>‚Ä¢ ${issue}</li>
                      `)}
                    </ul>
                  </div>
                `}

                ${Array.isArray(analysisResult.suggestions) && analysisResult.suggestions.length > 0 && html`
                  <div>
                    <h5 className="font-medium text-gray-700 mb-2">Suggestions:</h5>
                    <ul className="text-sm text-gray-600 space-y-1">
                      ${analysisResult.suggestions.map(suggestion => html`
                        <li key=${suggestion}>‚Ä¢ ${suggestion}</li>
                      `)}
                    </ul>
                  </div>
                `}
              `}
            </div>
          `}
        </div>
      `;
    }

    function App() {
      const [records, setRecords] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [activeId, setActiveId] = useState(null);
      const [sortBy, setSortBy] = useState('street');
      const [showAnalyzer, setShowAnalyzer] = useState(false);
      const [modalRecord, setModalRecord] = useState(null);
      const [isModalOpen, setIsModalOpen] = useState(false);

      useEffect(() => {
        let isMounted = true;

        async function loadData() {
          try {
            const response = await fetch('/api/streets');
            if (!response.ok) {
              throw new Error('Unable to fetch street data.');
            }

            const payload = await response.json();
            if (isMounted) {
              setRecords(Array.isArray(payload.records) ? payload.records : []);
            }
          } catch (err) {
            console.error(err);
            if (isMounted) {
              setError(
                'Unable to load the latest collection information right now. Please try again soon.'
              );
            }
          } finally {
            if (isMounted) {
              setLoading(false);
            }
          }
        }

        loadData();

        return () => {
          isMounted = false;
        };
      }, []);

      const sortedRecords = useMemo(() => {
        const filtered = [...records].filter((record) => Boolean(record.street));
        
        return filtered.sort((a, b) => {
          switch (sortBy) {
            case 'status':
              const statusOrder = { 'Not Started': 0, 'In Progress': 1, 'Completed': 2 };
              const aStatus = normalizeStatus(a.status || 'Unknown');
              const bStatus = normalizeStatus(b.status || 'Unknown');
              const aOrder = statusOrder[aStatus] ?? 3;
              const bOrder = statusOrder[bStatus] ?? 3;
              if (aOrder !== bOrder) return aOrder - bOrder;
              return a.street.localeCompare(b.street);
            case 'route':
              const aRoute = parseInt(a.routeNumber) || 999;
              const bRoute = parseInt(b.routeNumber) || 999;
              if (aRoute !== bRoute) return aRoute - bRoute;
              return a.street.localeCompare(b.street);
            case 'street':
            default:
              return a.street.localeCompare(b.street);
          }
        });
      }, [records, sortBy]);

      const filteredRecords = useMemo(() => {
        const term = searchTerm.trim().toLowerCase();
        if (!term) {
          return sortedRecords;
        }

        return sortedRecords.filter((record) =>
          record.street.toLowerCase().includes(term)
        );
      }, [sortedRecords, searchTerm]);

      useEffect(() => {
        if (!activeId && filteredRecords.length > 0) {
          setActiveId(filteredRecords[0].id);
        }
      }, [filteredRecords, activeId]);

      const selectedRecord = useMemo(() => {
        if (!activeId) {
          return null;
        }

        return records.find((record) => record.id === activeId) ?? null;
      }, [records, activeId]);

      const openModal = (record) => {
        setModalRecord(record);
        setIsModalOpen(true);
      };

      const closeModal = () => {
        setIsModalOpen(false);
        setModalRecord(null);
      };

      let mainContent;

      if (loading) {
        mainContent = html`<div className="mt-8">
          <${LoadingSpinner} />
        </div>`;
      } else if (error) {
        mainContent = html`<div className="mt-8 rounded-lg bg-red-50 border border-red-200 p-6">
          <div className="flex items-center">
            <div className="text-red-500 text-xl mr-3">‚ö†Ô∏è</div>
            <div>
              <h3 className="text-sm font-medium text-red-800">Unable to load data</h3>
              <p className="text-sm text-red-700 mt-1">${error}</p>
            </div>
          </div>
        </div>`;
      } else {
        const resultsList =
          filteredRecords.length === 0
            ? html`<div className="p-6 text-center">
                <div className="text-4xl mb-3">üîç</div>
                <p className="text-sm text-gray-500">
                  No streets match that search. Try another name or double-check your spelling.
                </p>
              </div>`
            : html`<ul className="divide-y divide-gray-200">
                ${filteredRecords.map((record) => {
                  return html`<li key=${record.id}>
                    <button
                      type="button"
                      onClick=${() => openModal(record)}
                      className="flex w-full items-center justify-between px-4 py-4 min-h-[60px] text-left transition-all duration-200 card-hover hover:bg-gray-50 hover:border-l-4 hover:border-l-gray-300"
                    >
                      <div className="flex-1">
                        <p className="font-medium text-gray-900">${record.street}</p>
                        <p className="text-sm text-gray-500 mt-1">
                          Route ${record.routeNumber || '--'}
                        </p>
                      </div>
                      <div className="flex items-center space-x-2">
                        <${StatusBadge} status=${record.status || 'Unknown'} />
                        <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                      </div>
                    </button>
                  </li>`;
                })}
              </ul>`;

        const detailBody = selectedRecord
          ? html`<div className="space-y-4">
              <div className="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-lg font-semibold text-green-800">${selectedRecord.street}</h3>
                  <${StatusBadge} status=${selectedRecord.status || 'Unknown'} />
                </div>
                <p className="text-sm text-green-700">Route ${selectedRecord.routeNumber || '--'}</p>
              </div>
              
              <dl className="space-y-3">
                <div className="flex items-center justify-between py-2 border-b border-gray-100">
                  <dt className="text-sm font-medium text-gray-600 flex items-center">
                    <span className="mr-2">üìÖ</span>
                    Date Started
                  </dt>
                  <dd className="text-sm font-medium text-gray-900">
                    ${formatDate(selectedRecord.dateStarted)}
                  </dd>
                </div>
                <div className="flex items-center justify-between py-2 border-b border-gray-100">
                  <dt className="text-sm font-medium text-gray-600 flex items-center">
                    <span className="mr-2">‚úÖ</span>
                    Date Completed
                  </dt>
                  <dd className="text-sm font-medium text-gray-900">
                    ${formatDate(selectedRecord.dateCompleted)}
                  </dd>
                </div>
                
                ${selectedRecord.notes && selectedRecord.notes.trim() && html`
                  <div className="py-2">
                    <dt className="text-sm font-medium text-gray-600 flex items-center mb-2">
                      <span className="mr-2">üìù</span>
                      Notes
                    </dt>
                    <dd className="text-sm text-gray-900 bg-gray-50 p-3 rounded-lg border">
                      ${selectedRecord.notes}
                    </dd>
                  </div>
                `}
              </dl>
            </div>`
          : filteredRecords.length === 0
          ? html`<div className="text-center py-8">
              <div className="text-4xl mb-3">üè†</div>
              <p className="text-sm text-gray-500">
                Start typing to find your street and see its pickup details.
              </p>
            </div>`
          : html`<div className="text-center py-8">
              <div className="text-4xl mb-3">üìç</div>
              <p className="text-sm text-gray-500">
                Select a street from the list to view its route and collection dates.
              </p>
            </div>`;

        mainContent = html`<div className="mt-8 grid gap-6 grid-cols-1 lg:grid-cols-[2fr,3fr] mobile-stack">
          <section aria-label="Street results" className="space-y-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-2">
                <span className="text-sm font-medium text-gray-600">
                  ${filteredRecords.length} ${filteredRecords.length === 1 ? 'result' : 'results'}
                </span>
                ${filteredRecords.length > 0 ? html`<span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  ${filteredRecords.filter(r => r.status === 'Completed').length} completed
                </span>` : null}
              </div>
              <div className="flex items-center space-x-3">
                <div className="flex items-center space-x-2">
                  <label htmlFor="sort-select" className="text-sm font-medium text-gray-600 flex items-center">
                    <span className="mr-1">üîÄ</span>
                    Sort by:
                  </label>
                  <select
                    id="sort-select"
                    value=${sortBy}
                    onChange=${(e) => setSortBy(e.target.value)}
                    className="text-sm border border-gray-300 rounded-md px-3 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 hover:border-green-400 transition-colors"
                  >
                    <option value="street">Street Name</option>
                    <option value="status">Status</option>
                    <option value="route">Route Number</option>
                  </select>
                </div>
                ${searchTerm
                  ? html`<button
                      type="button"
                      onClick=${() => {
                        setSearchTerm('');
                        setActiveId(null);
                      }}
                      className="text-sm text-green-600 hover:text-green-700 font-medium"
                    >
                      Clear search
                    </button>`
                  : null}
              </div>
            </div>
            <div className="max-h-96 overflow-y-auto rounded-lg border border-gray-200 bg-white/90 backdrop-blur-sm shadow-sm scroll-container">
              ${resultsList}
            </div>
          </section>

          <section aria-live="polite" aria-label="Street details" className="space-y-4">
            <div className="rounded-lg border border-gray-200 bg-white/90 backdrop-blur-sm p-6 shadow-sm">
              <h2 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <span className="mr-2">üìã</span>
                Collection Details
              </h2>
              ${detailBody}
            </div>
          </section>
        </div>`;
      }

      return html`<div className="min-h-screen app-background px-3 md:px-4 py-6 md:py-10">
        <div className="mx-auto flex max-w-6xl flex-col gap-4 md:gap-8 app-content">
          <header className="text-center">
            <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg p-4 md:p-8 border border-green-200">
              <div className="flex items-center justify-center mb-3 md:mb-4">
                <div className="text-3xl md:text-4xl mr-2 md:mr-3">üçÇ</div>
                <h1 className="text-2xl md:text-4xl font-bold text-green-800">
                  Westlake Leaf Collection Tracker
                </h1>
              </div>
              <p className="text-base md:text-lg text-gray-600 mb-3 md:mb-4">
                Search your street to see the latest pickup status
              </p>
              <div className="flex gap-3 justify-center mb-2 flex-wrap">
                <button
                  onClick=${() => setShowAnalyzer(!showAnalyzer)}
                  className="bg-blue-600 text-white px-6 py-3 min-h-[48px] rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center"
                >
                  <span className="mr-2">üì∏</span>
                  ${showAnalyzer ? 'Hide' : 'Analyze'} My Pile
                </button>
              </div>
              <p className="text-sm text-gray-500">
                Updated daily by the Westlake Service Department
              </p>
            </div>
          </header>

          ${showAnalyzer ? html`
            <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200 p-4 md:p-6 mb-4 md:mb-6">
              <${CameraAnalysis} />
            </div>
          ` : null}

          <main className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
            <div className="bg-gradient-to-r from-green-600 to-green-700 px-4 md:px-6 py-3 md:py-4">
              <div className="flex flex-col gap-4">
                <label className="text-sm font-medium text-white flex items-center" htmlFor="street-search">
                  <span className="mr-2">üîç</span>
                  Search for your street
                </label>
                <input
                  id="street-search"
                  type="search"
                  placeholder="Start typing to find your street..."
                  value=${searchTerm}
                  onChange=${(event) => setSearchTerm(event.target.value)}
                  className="w-full rounded-lg border-0 px-4 py-3 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 bg-white text-gray-900 placeholder-gray-500"
                />
              </div>
            </div>
            
            <div className="p-4 md:p-6">
              ${mainContent}
            </div>
          </main>
        </div>
        
        <${RouteModal} record=${modalRecord} isOpen=${isModalOpen} onClose=${closeModal} />
        <${InstallPrompt} />
      </div>`;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(html`<${App} />`);
  </script>
</body>
</html>
