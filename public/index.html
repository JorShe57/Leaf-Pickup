<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Westlake Leaf Collection Tracker</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Track leaf collection routes and schedules for Westlake. Check your street's pickup status and analyze your leaf pile.">
  <meta name="theme-color" content="#1a6b2e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Leaf Tracker">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Icons for iOS -->
  <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png">
  <link rel="apple-touch-icon" sizes="128x128" href="/icons/icon-128x128.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png">
  <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-152x152.png">
  
  <!-- Preload critical resources -->
  <link rel="preload" href="/images/sebastian-volkel-7QT_puk5CJQ-unsplash.jpg.webp" as="image">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
  <script src="https://unpkg.com/gsap@3.12.2/dist/gsap.min.js"></script>
  <!-- DOMPurify for HTML sanitization (security) -->
  <script src="https://unpkg.com/dompurify@3.0.6/dist/purify.min.js"></script>
  
  <style>
    :root {
      /* Primary Colors */
      --primary-green: #1a6b2e;
      --primary-green-dark: #145523;
      --primary-green-hover: #226b38;
      
      /* Accent Colors */
      --accent-blue-overlay: rgba(25, 55, 95, 0.65);
      --accent-gold: #d4af37;
      
      /* Neutral Colors */
      --white: #ffffff;
      --off-white: #f8f9fa;
      --light-gray: #e8e9eb;
      --medium-gray: #6c757d;
      --dark-gray: #343a40;
      --black: #000000;
      
      /* Text Colors */
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --text-on-green: #ffffff;
      --text-on-dark: #ffffff;
      
      /* Background Colors */
      --bg-primary: #ffffff;
      --bg-navigation: #1a6b2e;
      --bg-hero-overlay: linear-gradient(to bottom, rgba(25, 55, 95, 0.3), rgba(25, 55, 95, 0.7));
      --bg-button-green: #1a6b2e;
      --bg-button-hover: #226b38;
      
      /* Border Colors */
      --border-light: #dee2e6;
      --border-medium: #ced4da;
      
      /* Button/Interactive Elements */
      --button-primary-bg: #1a6b2e;
      --button-primary-hover: #226b38;
      --button-primary-text: #ffffff;
      --button-outline-border: #1a6b2e;
      
      /* Icon Colors */
      --icon-green: #1a6b2e;
      --icon-alert: #ffc107;
    }

    /* Custom loading spinner */
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--light-gray);
      border-top: 4px solid var(--primary-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Skeleton loading animation */
    .skeleton {
      background: linear-gradient(90deg, var(--light-gray) 25%, var(--off-white) 50%, var(--light-gray) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Status indicator animations */
    .status-pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Card hover effects */
    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(26, 107, 46, 0.15);
    }

    /* Camera analysis animations */
    .camera-preview {
      transition: all 0.3s ease;
    }

    .analysis-loading {
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Mobile optimizations and touch improvements */
    * {
      -webkit-tap-highlight-color: rgba(26, 107, 46, 0.2);
    }
    
    /* Safe area support for notched devices */
    body {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      margin: 0;
      min-height: 100vh;
      min-height: 100dvh; /* Dynamic viewport height for mobile Safari */
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
    }
    
    html {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      min-height: 100dvh; /* Dynamic viewport height for mobile Safari */
      overflow-x: hidden;
      overflow-y: auto;
    }
    
    /* Better scrolling on mobile */
    .scroll-container {
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      overflow-y: auto;
      touch-action: pan-y;
    }
    
    /* Touch target improvements - minimum 44x44px */
    button, a, input, select {
      min-height: 44px;
      touch-action: manipulation;
    }
    
    /* Active state feedback for touch */
    button:active, .card-hover:active {
      transform: scale(0.98);
      transition: transform 0.1s ease;
    }
    
    /* Allow scrolling on all containers */
    .app-background, .app-content, main, div {
      touch-action: auto;
    }
    
    /* Re-enable manipulation for interactive elements only */
    button, a, input[type="button"], input[type="submit"], select {
      touch-action: manipulation;
    }
    
    /* Ensure modals are scrollable */
    .fixed {
      touch-action: auto;
    }
    
    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Mobile-specific styles */
    @media (max-width: 768px) {
      .camera-container {
        margin: 0 -1rem;
      }
      
      .camera-preview {
        height: 200px;
      }
      
      /* Hide desktop-only elements */
      .desktop-only {
        display: none !important;
      }
      
      /* Stack layout on mobile */
      .mobile-stack {
        grid-template-columns: 1fr !important;
      }
      
      /* Larger text for readability */
      body {
        font-size: 16px;
      }
      
      /* Better spacing on mobile */
      .mobile-spacing {
        padding: 0.75rem !important;
      }
      
      /* Full width buttons on mobile */
      .mobile-full-button {
        width: 100%;
      }
    }

    /* Background image styling */
    .app-background {
      position: relative;
      background-image: url('/images/sebastian-volkel-7QT_puk5CJQ-unsplash.jpg.webp');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: scroll;
      min-height: 100vh;
      min-height: 100dvh; /* Dynamic viewport height for mobile Safari */
      touch-action: pan-y;
      -webkit-overflow-scrolling: touch;
    }

    .app-background::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        135deg,
        rgba(26, 107, 46, 0.85) 0%,
        rgba(25, 55, 95, 0.75) 50%,
        rgba(26, 107, 46, 0.85) 100%
      );
      z-index: 1;
      pointer-events: none;
    }

    .app-content {
      position: relative;
      z-index: 2;
      -webkit-overflow-scrolling: touch;
    }

    @media (min-width: 1024px) {
      .app-background {
        background-attachment: fixed;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
    const { useState, useEffect, useMemo } = React;
    const html = htm.bind(React.createElement);

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('/sw.js')
          .then((registration) => {
            console.log('[PWA] Service Worker registered:', registration.scope);
            
            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New update available
                  if (confirm('A new version is available! Reload to update?')) {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch((error) => {
            console.error('[PWA] Service Worker registration failed:', error);
          });
      });
      
      // Handle controller change (new service worker activated)
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        console.log('[PWA] Service Worker controller changed');
      });
    }

    // Install Prompt Handler
    let deferredPrompt = null;
    let installPromptShown = false;

    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('[PWA] Install prompt available');
      e.preventDefault();
      deferredPrompt = e;
      
      // Show install button (will be handled in React component)
      window.dispatchEvent(new CustomEvent('pwa-installable', { detail: { prompt: e } }));
    });

    window.addEventListener('appinstalled', () => {
      console.log('[PWA] App installed successfully');
      deferredPrompt = null;
    });

    // Function to show install prompt
    async function showInstallPrompt() {
      if (!deferredPrompt) {
        // Check if already installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
          alert('App is already installed!');
          return false;
        }
        
        // Show iOS instructions
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        
        if (isIOS || isSafari) {
          alert('To install on iOS:\n\n1. Tap the Share button (box with arrow)\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" to confirm');
          return false;
        }
        
        return false;
      }
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('[PWA] Install prompt outcome:', outcome);
      
      if (outcome === 'accepted') {
        deferredPrompt = null;
        return true;
      }
      
      return false;
    }

    // Check if running as installed PWA
    function isInstalled() {
      return window.matchMedia('(display-mode: standalone)').matches || 
             window.navigator.standalone === true;
    }

    const statusStyles = {
      'Not Started': 'bg-gray-100 text-gray-700 border-gray-300',
      'Up Next': 'bg-blue-100 text-blue-800 border-blue-300',
      'In Progress': 'bg-yellow-100 text-yellow-800 border-yellow-300 status-pulse',
      'Completed 1st Pass': 'bg-green-100 text-green-800 border-green-300',
      'Completed 2nd Pass': 'bg-emerald-100 text-emerald-800 border-emerald-300',
      'Completed 3rd Pass': 'bg-teal-100 text-teal-800 border-teal-300',
      'Completed 4th Pass': 'bg-cyan-100 text-cyan-800 border-cyan-300',
      // Legacy support - keeping old "Completed" for backward compatibility
      Completed: 'bg-green-100 text-green-800 border-green-300',
    };

    const statusIcons = {
      'Not Started': '⏳',
      'Up Next': '🔜',
      'In Progress': '🔄',
      'Completed 1st Pass': '✅',
      'Completed 2nd Pass': '✅',
      'Completed 3rd Pass': '✅',
      'Completed 4th Pass': '✅',
      // Legacy support
      Completed: '✅',
    };

    function normalizeStatus(value) {
      if (!value) {
        return 'Unknown';
      }

      const normalized = value.trim().toLowerCase();
      
      // Debug logging to help troubleshoot
      console.log('normalizeStatus input:', { original: value, trimmed: value.trim(), lowercased: normalized });
      
      switch (normalized) {
        case 'not started':
          return 'Not Started';
        case 'up next':
        case 'upnext':
        case 'up-next':
          return 'Up Next';
        case 'in progress':
        case 'in-progress':
        case 'in progess':
        case 'in proggress':
          return 'In Progress';
        case 'completed 1st pass':
        case 'completed first pass':
        case '1st pass':
        case 'first pass':
          return 'Completed 1st Pass';
        case 'completed 2nd pass':
        case 'completed second pass':
        case '2nd pass':
        case 'second pass':
          return 'Completed 2nd Pass';
        case 'completed 3rd pass':
        case 'completed third pass':
        case '3rd pass':
        case 'third pass':
          return 'Completed 3rd Pass';
        case 'completed 4th pass':
        case 'completed fourth pass':
        case '4th pass':
        case 'fourth pass':
          return 'Completed 4th Pass';
        case 'completed':
        case 'complete':
          return 'Completed';
        default:
          console.log('normalizeStatus: No match found for:', normalized);
          return value;
      }
    }

    // Helper function to check if a status is any type of completed status
    function isCompletedStatus(status) {
      const normalized = normalizeStatus(status);
      return normalized === 'Completed' || 
             normalized === 'Completed 1st Pass' || 
             normalized === 'Completed 2nd Pass' || 
             normalized === 'Completed 3rd Pass' || 
             normalized === 'Completed 4th Pass';
    }

    function StatusBadge({ status = 'Unknown' }) {
      const normalizedStatus = normalizeStatus(status);
      
      // Map to abbreviated labels with single checkmark for completed passes
      const abbreviatedLabels = {
        'Not Started': 'Not Started',
        'Up Next': 'Up Next', 
        'In Progress': 'In Progress',
        'Completed 1st Pass': '1st Pass ✅',
        'Completed 2nd Pass': '2nd Pass ✅',
        'Completed 3rd Pass': '3rd Pass ✅',
        'Completed 4th Pass': '4th Pass ✅',
        'Completed': '1st Pass ✅'
      };
      
      const label = abbreviatedLabels[normalizedStatus] ?? normalizedStatus;
      const baseClasses =
        'inline-flex items-center rounded-full px-3 py-1 text-sm font-medium border whitespace-nowrap';
      const variant = statusStyles[normalizedStatus] ?? 'bg-gray-100 text-gray-700 border-gray-300';

      // Debug logging to help troubleshoot
      if (normalizedStatus === 'Unknown' && status !== 'Unknown') {
        console.log('StatusBadge: Unknown status detected:', { original: status, normalized: normalizedStatus });
      }

      return html`<span className="${baseClasses} ${variant}">
        ${label}
      </span>`;
    }

    function LoadingSpinner() {
      return html`<div className="flex flex-col items-center justify-center py-8">
        <div className="loading-spinner mb-4"></div>
        <p className="text-sm text-gray-600">Loading collection routes...</p>
      </div>`;
    }

    function SkeletonCard() {
      return html`<div className="animate-pulse">
        <div className="skeleton h-4 w-3/4 mb-2 rounded"></div>
        <div className="skeleton h-3 w-1/2 mb-3 rounded"></div>
        <div className="skeleton h-6 w-20 rounded-full"></div>
      </div>`;
    }

    function SkeletonList() {
      return html`<div className="space-y-3">
        ${Array.from({ length: 5 }, (_, i) => html`<div key=${i} className="p-4 border rounded-lg">
          <${SkeletonCard} />
        </div>`)}
      </div>`;
    }

    function RouteModal({ record, isOpen, onClose }) {
      // Email Alert Subscription Form State
      const [formData, setFormData] = useState({
        subscriberName: '',
        email: '',
        optInConfirmed: false
      });
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [submitError, setSubmitError] = useState(null);
      const [submitSuccess, setSubmitSuccess] = useState(false);

      // Form submission handler
      const handleSubmit = async (e) => {
        e.preventDefault();
        
        // Validation
        if (!formData.subscriberName.trim()) {
          alert('Please enter your name');
          return;
        }
        
        if (!formData.email.trim()) {
          alert('Please enter your email address');
          return;
        }
        
        if (!formData.optInConfirmed) {
          alert('Please confirm you want to receive email alerts');
          return;
        }
        
        setIsSubmitting(true);
        setSubmitError(null);
        setSubmitSuccess(false);
        
        try {
          const response = await fetch('/api/subscribe-sms', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              subscriberName: formData.subscriberName,
              email: formData.email,
              streetId: record.id
            })
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to subscribe');
          }
          
          // Success!
          setSubmitSuccess(true);
          setFormData({
            subscriberName: '',
            email: '',
            optInConfirmed: false
          });
          
          // Close modal after 2 seconds
          setTimeout(() => {
            onClose();
          }, 2000);
          
        } catch (error) {
          console.error('Subscription error:', error);
          setSubmitError('Failed to subscribe. Please try again.');
        } finally {
          setIsSubmitting(false);
        }
      };

      if (!isOpen || !record) return null;

      return html`
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 pt-16 z-[100]" style=${{ touchAction: 'none' }}>
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto relative z-[101]" style=${{ touchAction: 'pan-y' }}>
            <div className="flex items-center justify-between p-4 border-b border-gray-200">
              <h3 className="text-lg font-semibold text-gray-900">Route Details</h3>
              <button
                onClick=${onClose}
                className="text-gray-400 hover:text-gray-600 transition-colors"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            
            <div className="p-4 space-y-4">
              <div className="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                <div className="flex items-center justify-between mb-2">
                  <h4 className="text-lg font-semibold text-green-800">${record.street}</h4>
                  <${StatusBadge} status=${record.status || 'Unknown'} />
                </div>
                <p className="text-sm text-green-700">Route ${record.routeNumber || '--'}</p>
              </div>
              
              <div className="space-y-3">
                <div className="flex items-center justify-between py-2 border-b border-gray-100">
                  <dt className="text-sm font-medium text-gray-600 flex items-center">
                    <span className="mr-2">📅</span>
                    Date Started
                  </dt>
                  <dd className="text-sm font-medium text-gray-900">
                    ${formatDate(record.dateStarted)}
                  </dd>
                </div>
                
                <div className="flex items-center justify-between py-2 border-b border-gray-100">
                  <dt className="text-sm font-medium text-gray-600 flex items-center">
                    <span className="mr-2">✅</span>
                    Date Completed
                  </dt>
                  <dd className="text-sm font-medium text-gray-900">
                    ${formatDate(record.dateCompleted)}
                  </dd>
                </div>
                
                ${record.notes && record.notes.trim() && html`
                  <div className="py-2">
                    <dt className="text-sm font-medium text-gray-600 flex items-center mb-2">
                      <span className="mr-2">📝</span>
                      Notes
                    </dt>
                    <dd className="text-sm text-gray-900 bg-gray-50 p-3 rounded-lg border">
                      ${record.notes}
                    </dd>
                  </div>
                `}
              </div>

              <!-- Email Alert Subscription Section -->
              <div className="border-t border-gray-200 pt-4 mt-4">
                <div className="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200 mb-4">
                  <div className="flex items-start space-x-3">
                    <span className="text-2xl">📧</span>
                    <div className="flex-1">
                      <h5 className="text-sm font-semibold text-gray-900 mb-1">
                        Get Email Alerts
                      </h5>
                      <p className="text-xs text-gray-600 mb-3">
                        Receive email updates when ${record.street}'s leaf pickup status changes.
                      </p>
                    </div>
                  </div>
                </div>
                
                ${submitSuccess ? html`
                  <div className="bg-green-50 border border-green-200 rounded-lg p-4 flex items-start space-x-3 mb-4">
                    <span className="text-xl">✅</span>
                    <div>
                      <p className="text-sm font-medium text-green-800">Successfully subscribed!</p>
                      <p className="text-xs text-green-600 mt-1">You'll receive email alerts for ${record.street}</p>
                    </div>
                  </div>
                ` : html`
                  <form onSubmit=${handleSubmit} className="space-y-4">
                    ${submitError && html`
                      <div className="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start space-x-3">
                        <span className="text-xl">⚠️</span>
                        <div>
                          <p className="text-sm font-medium text-red-800">Error</p>
                          <p className="text-xs text-red-600 mt-1">${submitError}</p>
                        </div>
                      </div>
                    `}
                    
                    <div>
                      <label htmlFor="subscriberName" className="block text-sm font-medium text-gray-700 mb-1">
                        Your Name *
                      </label>
                      <input
                        id="subscriberName"
                        type="text"
                        placeholder="John Doe"
                        value=${formData.subscriberName}
                        onInput=${(e) => setFormData({ ...formData, subscriberName: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        required
                      />
                    </div>
                    
                    <div>
                      <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
                        Email Address *
                      </label>
                      <input
                        id="email"
                        type="email"
                        placeholder="john@example.com"
                        value=${formData.email}
                        onInput=${(e) => setFormData({ ...formData, email: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        required
                      />
                    </div>
                    
                    <div className="flex items-start space-x-2">
                      <input
                        id="optInConfirmed"
                        type="checkbox"
                        checked=${formData.optInConfirmed}
                        onChange=${(e) => setFormData({ ...formData, optInConfirmed: e.target.checked })}
                        className="mt-1 h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                        required
                      />
                      <label htmlFor="optInConfirmed" className="text-xs text-gray-600">
                        I agree to receive email alerts about leaf pickup status for ${record.street}. To opt out of this service, email jshevel@cityofwestlake.org
                      </label>
                    </div>
                    
                    <button
                      type="submit"
                      disabled=${isSubmitting}
                      className="w-full px-4 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 disabled:bg-gray-400 transition"
                    >
                      ${isSubmitting ? 'Subscribing...' : 'Subscribe to Alerts'}
                    </button>
                  </form>
                `}
              </div>
              
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <p className="text-xs text-blue-700 flex items-center">
                  <span className="mr-2">ℹ️</span>
                  This information reflects the most recent update from the Westlake Service Department.
                </p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function isHtmlReportString(value) {
      if (typeof value !== 'string') {
        return false;
      }

      const trimmed = value.trim();
      if (!trimmed) {
        return false;
      }

      if (/^<!DOCTYPE\s+html>/i.test(trimmed) || /^<html[\s>]/i.test(trimmed) || /<body[\s>]/i.test(trimmed)) {
        return true;
      }

      return /<\/(article|section|main|header|footer|div|p|ul|ol|li|table|thead|tbody|tr|td|h[1-6])>/i.test(trimmed);
    }

    function normalizeReportToText(value) {
      if (value === null || value === undefined) {
        return '';
      }

      if (typeof value === 'string') {
        return value;
      }

      if (Array.isArray(value)) {
        return value.map(normalizeReportToText).filter(Boolean).join('\n');
      }

      if (typeof value === 'object') {
        const htmlCandidateKeys = ['html', 'reportHtml', 'reportContent', 'content', 'body', 'markup', 'report'];
        for (const key of htmlCandidateKeys) {
          if (typeof value[key] === 'string' && isHtmlReportString(value[key])) {
            return value[key];
          }
        }

        const parts = Object.entries(value)
          .map(([key, val]) => {
            const normalized = normalizeReportToText(val).trim();
            if (!normalized) {
              return '';
            }
            return `${key}: ${normalized}`;
          })
          .filter(Boolean);

        if (parts.length > 0) {
          return parts.join('\n');
        }

        try {
          return JSON.stringify(value, null, 2);
        } catch (error) {
          return String(value);
        }
      }

      return String(value);
    }

    function extractHtmlReportMarkup(reportString) {
      const stripScripts = (input) =>
        (input || '').replace(/<script[\s\S]*?<\/script>/gi, '');

      const bulletRemovalCSS = `
        <style>
          .list-item,
          .action-item,
          ul,
          ol {
            list-style: none !important;
            padding-left: 0 !important;
            margin-left: 0 !important;
          }
        </style>
      `;

      const cleaned = reportString.replace(/\r\n/g, '\n');
      const assembleOutput = (styles, body) => {
        const sanitizedBody = body.replace(/##\s+[^\n<]+/g, '');
        const combined = `${styles}\n${bulletRemovalCSS}\n${sanitizedBody}`.trim();
        return stripScripts(combined);
      };

      if (typeof DOMParser !== 'undefined') {
        try {
          const parser = new DOMParser();
          const doc = parser.parseFromString(cleaned, 'text/html');
          if (doc) {
            const headStyles = Array.from(doc.querySelectorAll('style'))
              .map((node) => node.outerHTML)
              .join('\n');
            const bodyMarkup =
              (doc.body && doc.body.innerHTML && doc.body.innerHTML.trim()) || cleaned;
            return assembleOutput(headStyles, bodyMarkup);
          }
        } catch (_error) {
          // Fallback to regex parsing below
        }
      }

      const bodyMatch = cleaned.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
      const headMatch = cleaned.match(/<head[^>]*>([\s\S]*?)<\/head>/i);

      const styles = headMatch && headMatch[1]
        ? (headMatch[1].match(/<style[\s\S]*?<\/style>/gi) || []).join('\n')
        : '';

      const bodyContent = bodyMatch && bodyMatch[1] ? bodyMatch[1] : cleaned;

      return assembleOutput(styles, bodyContent);
    }

    function extractHtmlMarkupFromContent(content) {
      if (content === null || content === undefined) {
        return null;
      }

      if (typeof content === 'string') {
        return isHtmlReportString(content) ? extractHtmlReportMarkup(content) : null;
      }

      if (Array.isArray(content)) {
        for (const item of content) {
          const markup = extractHtmlMarkupFromContent(item);
          if (markup) {
            return markup;
          }
        }
        return null;
      }

      if (typeof content === 'object') {
        const htmlCandidateKeys = ['html', 'reportHtml', 'reportContent', 'content', 'body', 'markup', 'report'];
        for (const key of htmlCandidateKeys) {
          if (typeof content[key] === 'string' && isHtmlReportString(content[key])) {
            return extractHtmlReportMarkup(content[key]);
          }
        }

        for (const value of Object.values(content)) {
          const markup = extractHtmlMarkupFromContent(value);
          if (markup) {
            return markup;
          }
        }
      }

      return null;
    }

    /**
     * Sanitize HTML content to prevent XSS attacks
     * @param {string} htmlString - Raw HTML string
     * @returns {string} Sanitized HTML string
     */
    function sanitizeHtml(htmlString) {
      if (typeof DOMPurify === 'undefined') {
        console.error('DOMPurify not loaded - stripping all HTML');
        return htmlString.replace(/<[^>]*>/g, '');
      }
      
      // Configure DOMPurify to allow safe HTML elements
      const cleanHtml = DOMPurify.sanitize(htmlString, {
        ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'ul', 'ol', 'li', 'strong', 'em', 'u', 'span', 'div', 'article', 'section'],
        ALLOWED_ATTR: ['class', 'style'],
        KEEP_CONTENT: true,
        ALLOW_DATA_ATTR: false
      });
      
      return cleanHtml;
    }

    function renderReportContent(content) {
      const htmlMarkup = extractHtmlMarkupFromContent(content);
      if (htmlMarkup) {
        // SECURITY: Sanitize HTML before rendering to prevent XSS
        const sanitizedHtml = sanitizeHtml(htmlMarkup);
        return html`<div
          className="prose prose-sm max-w-none"
          style=${{ listStyleType: 'none', paddingLeft: 0, marginLeft: 0 }}
          dangerouslySetInnerHTML=${{ __html: sanitizedHtml }}
        ></div>`;
      }

      const reportString = normalizeReportToText(content).trim();
      if (!reportString || isHtmlReportString(reportString)) {
        return null;
      }

      const lines = reportString
        .split(/\r?\n/)
        .map((line) => line.trim())
        .filter(Boolean);

      if (lines.length === 0) {
        return null;
      }

      const groups = [];
      lines.forEach((line) => {
        const isBullet = /^[-*•]/.test(line);
        const text = line.replace(/^[-*•]\s*/, '').trim();
        if (!text) {
          return;
        }

        const lastGroup = groups[groups.length - 1];

        if (isBullet) {
          if (lastGroup && lastGroup.type === 'list') {
            lastGroup.items.push(text);
          } else {
            groups.push({ type: 'list', items: [text] });
          }
        } else {
          if (lastGroup && lastGroup.type === 'text') {
            lastGroup.text = `${lastGroup.text} ${text}`.trim();
          } else {
            groups.push({ type: 'text', text });
          }
        }
      });

      return html`<div className="space-y-3 text-sm text-gray-700 leading-relaxed">
        ${groups.map((group, index) => {
          if (group.type === 'list') {
            return html`<ul key=${`list-${index}`} className="list-disc list-inside space-y-1 text-gray-700">
              ${group.items.map((item, itemIndex) => html`<li key=${`item-${index}-${itemIndex}`}>${item}</li>`)}
            </ul>`;
          }

          return html`<p key=${`text-${index}`}>${group.text}</p>`;
        })}
      </div>`;
    }

    function formatDate(value) {
      if (!value) {
        return '--';
      }

      // Handle date strings more explicitly to avoid timezone issues
      let parsed;
      if (typeof value === 'string') {
        // If it's in ISO date format (YYYY-MM-DD), parse it in local timezone
        if (/^\d{4}-\d{2}-\d{2}(T\d{2}:\d{2}:\d{2}(\.\d{3})?Z?)?$/.test(value)) {
          const [year, month, day] = value.split('T')[0].split('-');
          // Create date in local timezone to avoid UTC conversion
          parsed = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        }
        // If it's in MM/DD/YYYY format, parse it more carefully
        else if (value.includes('/')) {
          const [month, day, year] = value.split('/');
          // Create date in local timezone to avoid UTC conversion
          parsed = new Date(year, month - 1, day);
        } else {
          parsed = new Date(value);
        }
      } else {
        parsed = new Date(value);
      }

      if (Number.isNaN(parsed.getTime())) {
        return value;
      }

      return new Intl.DateTimeFormat('en-US', { dateStyle: 'medium' }).format(
        parsed
      );
    }

    // Install Prompt Banner Component
    function InstallPrompt() {
      const [showPrompt, setShowPrompt] = useState(false);
      const [isInstalled, setIsInstalled] = useState(false);

      useEffect(() => {
        // Check if already installed
        setIsInstalled(
          window.matchMedia('(display-mode: standalone)').matches || 
          window.navigator.standalone === true
        );

        // Listen for install prompt availability
        const handleInstallable = () => {
          if (!isInstalled) {
            setShowPrompt(true);
          }
        };

        window.addEventListener('pwa-installable', handleInstallable);
        
        // Check immediately if prompt is available
        if (deferredPrompt && !isInstalled) {
          setShowPrompt(true);
        }

        return () => {
          window.removeEventListener('pwa-installable', handleInstallable);
        };
      }, []);

      const handleInstall = async () => {
        const success = await showInstallPrompt();
        if (success) {
          setShowPrompt(false);
          setIsInstalled(true);
        }
      };

      const handleDismiss = () => {
        setShowPrompt(false);
      };

      if (isInstalled) {
        return null;
      }

      if (!showPrompt) {
        return null;
      }

      return html`
        <div 
          className="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-green-600 to-green-700 text-white p-4 shadow-lg z-40 border-t-4 border-green-400"
          style=${{ paddingBottom: 'calc(1rem + env(safe-area-inset-bottom))' }}
        >
          <div className="max-w-4xl mx-auto flex items-center justify-between gap-4">
            <div className="flex items-center flex-1">
              <span className="text-2xl mr-3">🍂</span>
              <div>
                <p className="font-semibold text-sm">Install Leaf Tracker</p>
                <p className="text-xs opacity-90">Get quick access from your home screen</p>
              </div>
            </div>
            <div className="flex gap-2">
              <button
                onClick=${handleInstall}
                className="bg-white text-green-700 px-4 py-2 rounded-lg font-medium text-sm hover:bg-green-50 transition-colors whitespace-nowrap"
              >
                Install
              </button>
              <button
                onClick=${handleDismiss}
                className="text-white hover:bg-green-800 px-3 py-2 rounded-lg transition-colors"
                aria-label="Dismiss"
              >
                ✕
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Camera Analysis Modal Component (file upload to n8n workflow)
    function CameraAnalysisModal({ isOpen, onClose }) {
      const [selectedFile, setSelectedFile] = useState(null);
      const [previewUrl, setPreviewUrl] = useState(null);
      const [analysisResult, setAnalysisResult] = useState(null);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [error, setError] = useState(null);
      const [isProcessingImage, setIsProcessingImage] = useState(false);
      const [payloadImage, setPayloadImage] = useState(null);
      const [uploadMeta, setUploadMeta] = useState(null);
      const fileInputRef = React.useRef(null);

      const complianceGuidelines = [
        "✅ Leaves should be loose (not bagged)",
        "✅ Keep piles at least 3 feet from the curb",
        "✅ Remove branches larger than 3 inches",
        "✅ No trash or debris mixed in",
        "✅ Pile should be a manageable size"
      ];

      const estimateSizeKb = (dataUrl) => {
        const base64 = dataUrl.split(',')[1] || '';
        return Math.round((base64.length * 0.75) / 1024);
      };

      const compressImage = (file) => {
        return new Promise((resolve, reject) => {
          const objectUrl = URL.createObjectURL(file);
          const image = new Image();
          image.onload = () => {
            try {
              const maxDimension = 1280;
              let { width, height } = image;
              const scale = Math.min(1, maxDimension / Math.max(width, height));
              const targetWidth = Math.round(width * scale);
              const targetHeight = Math.round(height * scale);

              const canvas = document.createElement('canvas');
              canvas.width = targetWidth;
              canvas.height = targetHeight;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(image, 0, 0, targetWidth, targetHeight);
              const dataUrl = canvas.toDataURL('image/jpeg', 0.82);

              URL.revokeObjectURL(objectUrl);

              resolve({
                dataUrl,
                width: targetWidth,
                height: targetHeight,
                sizeKb: estimateSizeKb(dataUrl),
              });
            } catch (err) {
              reject(err);
            }
          };
          image.onerror = () => {
            URL.revokeObjectURL(objectUrl);
            reject(new Error('Unable to read the selected image.'));
          };
          image.src = objectUrl;
        });
      };

      const handleFileChange = async (event) => {
        const file = event.target.files && event.target.files[0];
        if (!file) {
          return;
        }

        // Check if file is an image by MIME type or file extension
        const isImageMimeType = file.type.startsWith('image/');
        const imageExtensions = /\.(jpg|jpeg|png|gif|webp|heic|heif|bmp|tiff|tif)$/i;
        const isImageExtension = imageExtensions.test(file.name);
        
        if (!isImageMimeType && !isImageExtension) {
          setError('Please upload an image file (JPEG, PNG, HEIC, or other image formats).');
          setSelectedFile(null);
          setPreviewUrl(null);
          setPayloadImage(null);
          setUploadMeta(null);
          return;
        }

        setIsProcessingImage(true);
        setError(null);
        setAnalysisResult(null);
        setPayloadImage(null);
        setUploadMeta(null);

        try {
          const compressed = await compressImage(file);
          setSelectedFile(file);
          setPreviewUrl(compressed.dataUrl);
          setPayloadImage(compressed.dataUrl);
          setUploadMeta({
            sizeKb: compressed.sizeKb,
            width: compressed.width,
            height: compressed.height,
          });
        } catch (err) {
          console.error('Image compression failed:', err);
          // Check if it's a HEIC/HEIF file that the browser can't process
          const isHeic = /\.(heic|heif)$/i.test(file.name);
          if (isHeic) {
            setError('Your browser may not support HEIC format. On iPhone, try: Settings > Camera > Formats > "Most Compatible" to save as JPEG instead, or use a different photo app.');
          } else {
            setError('We were unable to process that image. Please try a different photo or format.');
          }
          setSelectedFile(null);
          setPreviewUrl(null);
          setPayloadImage(null);
          setUploadMeta(null);
        } finally {
          setIsProcessingImage(false);
        }
      };

      const handleSelectClick = () => {
        if (fileInputRef.current) {
          fileInputRef.current.value = null;
          fileInputRef.current.click();
        }
      };

      const submitForAnalysis = async () => {
        if (!payloadImage) {
          setError('Add a photo before requesting analysis.');
          return;
        }

        setIsSubmitting(true);
        setError(null);
        setAnalysisResult(null);

        const normalizeList = (value) => {
          if (!value && value !== 0) {
            return [];
          }

          if (Array.isArray(value)) {
            return value
              .map((item) => {
                if (!item && item !== 0) {
                  return '';
                }
                if (typeof item === 'string') {
                  return item.replace(/^[*-•]\s*/, '').trim();
                }
                if (item && typeof item === 'object') {
                  if (typeof item.message === 'string') {
                    return item.message.replace(/^[*-•]\s*/, '').trim();
                  }
                  if (typeof item.text === 'string') {
                    return item.text.replace(/^[*-•]\s*/, '').trim();
                  }
                }
                return String(item).replace(/^[*-•]\s*/, '').trim();
              })
              .filter(Boolean);
          }

          if (typeof value === 'string') {
            return value
              .split(/\n+/)
              .map((line) => line.replace(/^[*-•]\s*/, '').trim())
              .filter(Boolean);
          }

          return [String(value).replace(/^[*-•]\s*/, '').trim()].filter(Boolean);
        };

        try {
          console.log('[Camera Analysis] Sending request to n8n...');
          const response = await fetch('/api/analyze-pile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              image: payloadImage,
              filename: selectedFile ? selectedFile.name : 'leaf-pile.jpg',
            }),
          });

          console.log('[Camera Analysis] Response received:', response.status);

          if (!response.ok) {
            const error = new Error('Analysis request failed');
            error.status = response.status;
            throw error;
          }

          const rawResult = await response.json();
          const reportContentSource =
            rawResult.reportContent ??
            rawResult.report ??
            rawResult.message ??
            rawResult.content ??
            null;

          setAnalysisResult({
            issues: normalizeList(rawResult.issues),
            suggestions: normalizeList(rawResult.suggestions),
            reportContent: reportContentSource,
            analysisTimestamp: rawResult.analysisTimestamp || new Date().toISOString(),
            raw: rawResult,
          });
        } catch (err) {
          console.error('Analysis request failed:', err);
          if (err && err.status === 413) {
            setError('The photo was too large to send to the analyzer. Try retaking it from a little farther back or using a lower-resolution photo.');
          } else {
            setError('We could not reach the analysis service. Please try again in a moment.');
          }
        } finally {
          setIsSubmitting(false);
        }
      };

      const resetUpload = () => {
        setSelectedFile(null);
        setPreviewUrl(null);
        setAnalysisResult(null);
        setError(null);
        setPayloadImage(null);
        setUploadMeta(null);
        setIsSubmitting(false);
        if (fileInputRef.current) {
          fileInputRef.current.value = null;
        }
      };

      if (!isOpen) return null;

      return html`
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 pt-16 z-[100]" style=${{ touchAction: 'none' }}>
          <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto relative z-[101]" style=${{ touchAction: 'pan-y' }}>
            <div className="flex items-center justify-between p-4 border-b border-gray-200">
              <h3 className="text-lg font-semibold text-gray-900 flex items-center">
                <span className="mr-2">📸</span>
                Collection Analysis
              </h3>
              <button
                onClick=${onClose}
                className="text-gray-400 hover:text-gray-600 transition-colors p-2 rounded-lg hover:bg-gray-100 min-h-[44px] min-w-[44px] flex items-center justify-center"
                aria-label="Close analysis"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            
            <div className="p-4 space-y-6">
              <div className="bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg border border-blue-200">
                <p className="text-sm text-gray-600 mb-4">
                  Snap a photo of your leaf collection and upload it. Our AI will review the image and provide compliance guidance.
                </p>
                
                <div className="space-y-2">
                  <h4 className="text-sm font-medium text-gray-700">Collection Guidelines:</h4>
                  <ul className="text-xs text-gray-600 space-y-1">
                    ${complianceGuidelines.map(guideline => html`
                      <li key=${guideline}>${guideline}</li>
                    `)}
                  </ul>
                </div>
              </div>

          ${error && html`
            <div className="bg-red-50 border border-red-200 rounded-lg p-4">
              <div className="flex items-center">
                <div className="text-red-500 text-xl mr-3">⚠️</div>
                <div>
                  <h3 className="text-sm font-medium text-red-800">Upload Error</h3>
                  <p className="text-sm text-red-700 mt-1">${error}</p>
                </div>
              </div>
            </div>
          `}

          <div className="space-y-4">
            <input
              type="file"
              accept="image/*,.heic,.heif"
              capture="environment"
              ref=${fileInputRef}
              onChange=${handleFileChange}
              className="hidden"
            />

            <div
              className=${`border-2 border-dashed rounded-lg p-6 text-center transition ${previewUrl ? 'border-green-300 bg-green-50' : 'border-gray-300 hover:border-green-400'}`}
            >
              ${previewUrl ? html`
                <div className="space-y-3">
                  <img
                    src=${previewUrl}
                    alt="Leaf pile preview"
                    className="w-full rounded-md max-h-64 object-cover border border-green-200"
                  />
                  <p className="text-sm text-gray-600">
                    ${selectedFile ? selectedFile.name : 'leaf-pile.jpg'}
                  </p>
                  ${uploadMeta && html`
                    <p className="text-xs text-gray-500">
                      Optimized to ${uploadMeta.width}×${uploadMeta.height}px (~${uploadMeta.sizeKb} KB)
                    </p>
                  `}
                  <div className="flex justify-center gap-3">
                    <button
                      onClick=${handleSelectClick}
                      className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition"
                    >
                      Choose another photo
                    </button>
                    <button
                      onClick=${resetUpload}
                      className="px-4 py-2 bg-white border border-gray-300 text-gray-600 rounded-md hover:bg-gray-100 transition"
                    >
                      Remove
                    </button>
                  </div>
                </div>
              ` : html`
                <div className="space-y-3">
                  <div className="text-4xl">📷</div>
                  <p className="text-sm text-gray-600">
                    Tap below to snap a new photo or upload one from your device.
                  </p>
                  <button
                    onClick=${handleSelectClick}
                    className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition"
                  >
                    Select Photo
                  </button>
                  <p className="text-xs text-gray-500">
                    Works on mobile and desktop. Accepts all image formats including iPhone photos (HEIC/HEIF), JPEG, PNG, and more.
                  </p>
                </div>
              `}
            </div>

            <button
              type="button"
              onClick=${(e) => {
                e.preventDefault();
                e.stopPropagation();
                submitForAnalysis();
                return false;
              }}
              disabled=${isSubmitting || isProcessingImage || !payloadImage}
              className="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              ${isProcessingImage
                ? 'Optimizing photo...'
                : isSubmitting
                  ? 'Sending for analysis...'
                  : 'Send to Analysis'}
            </button>
            
            ${isSubmitting && html`
              <div className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div className="flex items-center">
                  <div className="loading-spinner mr-3"></div>
                  <div>
                    <p className="text-sm font-medium text-blue-800">AI analysis in progress...</p>
                    <p className="text-xs text-blue-700 mt-1">Hang tight—this usually takes under 10 seconds.</p>
                  </div>
                </div>
              </div>
            `}
          </div>

          ${analysisResult && (() => {
            const reportMarkup = renderReportContent(analysisResult.reportContent);

            return html`
              <div className="p-6 rounded-lg border-2 border-gray-200 bg-white">
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center">
                    <span className="text-2xl mr-3">📋</span>
                    <h4 className="text-lg font-semibold text-gray-900">
                      AI Analysis Report
                    </h4>
                  </div>
                  ${analysisResult.analysisTimestamp && html`
                    <p className="text-xs text-gray-500">
                      Completed: ${formatDate(analysisResult.analysisTimestamp)}
                    </p>
                  `}
                </div>

                ${reportMarkup ? html`
                  <div className="bg-white rounded-lg p-4 border border-gray-200">
                    ${reportMarkup}
                  </div>
                ` : html`
                  ${Array.isArray(analysisResult.issues) && analysisResult.issues.length > 0 && html`
                    <div className="mb-4">
                      <h5 className="text-sm font-medium text-red-700 mb-2">Issues Found:</h5>
                      <ul className="text-sm text-red-600 space-y-1">
                        ${analysisResult.issues.map((issue) => html`<li key=${issue}>• ${issue}</li>`)}
                      </ul>
                    </div>
                  `}

                  ${Array.isArray(analysisResult.suggestions) && analysisResult.suggestions.length > 0 && html`
                    <div>
                      <h5 className="text-sm font-medium text-gray-700 mb-2">Suggestions:</h5>
                      <ul className="text-sm text-gray-600 space-y-1">
                        ${analysisResult.suggestions.map((suggestion) => html`<li key=${suggestion}>• ${suggestion}</li>`)}
                      </ul>
                    </div>
                  `}

                  ${(!Array.isArray(analysisResult.issues) || analysisResult.issues.length === 0) &&
                    (!Array.isArray(analysisResult.suggestions) || analysisResult.suggestions.length === 0) && html`
                      <p className="text-sm text-gray-600">
                        The automation completed without additional notes. Please verify the pile visually.
                      </p>
                    `}
                `}
              </div>
            `;
          })()}
            </div>
          </div>
        </div>
      `;
    }

    /**
     * CollapsibleRoute Component
     * Displays a collapsible group of streets for a single route
     */
    function CollapsibleRoute({ routeNumber, records, isExpanded, onToggle, onStreetClick }) {
      const completedCount = records.filter(r => isCompletedStatus(r.status)).length;
      const totalCount = records.length;
      const completionPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
      
      // Determine overall route status
      const inProgressCount = records.filter(r => normalizeStatus(r.status) === 'In Progress').length;
      let routeStatus = 'Not Started';
      if (completedCount === totalCount) {
        routeStatus = 'Completed';
      } else if (completedCount > 0 || inProgressCount > 0) {
        routeStatus = 'In Progress';
      }

      return html`
        <div className="border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm mb-3">
          <button
            type="button"
            onClick=${onToggle}
            className="w-full px-4 py-4 min-h-[60px] bg-gradient-to-r from-green-50 to-green-100 hover:from-green-100 hover:to-green-150 transition-all duration-200 flex items-center justify-between"
          >
            <div className="flex items-center space-x-3 flex-1">
              <span className="text-xl transition-transform duration-200 ${isExpanded ? 'transform rotate-90' : ''}">
                ▶
              </span>
              <div className="text-left">
                <h3 className="text-lg font-bold text-green-800">
                  Route ${routeNumber || 'Unknown'}
                </h3>
                <p className="text-sm text-green-600">
                  ${totalCount} ${totalCount === 1 ? 'street' : 'streets'}
                </p>
              </div>
            </div>
            <div className="flex items-center space-x-2">
              <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${
                completionPercent === 100 
                  ? 'bg-green-100 text-green-800' 
                  : completionPercent > 0 
                    ? 'bg-yellow-100 text-yellow-800' 
                    : 'bg-gray-100 text-gray-700'
              }">
                ${completionPercent}% complete
              </span>
              <${StatusBadge} status=${routeStatus} />
            </div>
          </button>
          
          ${isExpanded ? html`
            <div className="border-t border-gray-200">
              <ul className="divide-y divide-gray-100">
                ${records.map((record) => html`
                  <li key=${record.id}>
                    <button
                      type="button"
                      onClick=${() => onStreetClick(record)}
                      className="flex w-full items-center justify-between px-6 py-3 min-h-[56px] text-left transition-all duration-200 hover:bg-gray-50"
                    >
                      <div className="flex-1">
                        <p className="font-medium text-gray-900">${record.street}</p>
                        ${record.dateStarted ? html`
                          <p className="text-xs text-gray-500 mt-1">
                            Started: ${formatDate(record.dateStarted)}
                          </p>
                        ` : null}
                      </div>
                      <div className="flex items-center space-x-2">
                        <${StatusBadge} status=${record.status || 'Unknown'} />
                        <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                      </div>
                    </button>
                  </li>
                `)}
              </ul>
            </div>
          ` : null}
        </div>
      `;
    }

    /**
     * HowToUse Component - Modal Version
     * Displays onboarding guide for the three main features
     */
    function HowToUse({ isOpen, onClose }) {
      const contentRef = React.useRef(null);

      useEffect(() => {
        if (isOpen && contentRef.current) {
          // Animate entrance with GSAP
          gsap.from(contentRef.current.querySelectorAll('.feature-card'), {
            opacity: 0.9,
            y: 15,
            duration: 0.3,
            stagger: 0.08,
            ease: 'power2.out'
          });
        }
      }, [isOpen]);

      if (!isOpen) return null;

      const features = [
        {
          icon: '🔍',
          title: 'Find Your Street',
          description: 'Search and track your street\'s pickup status',
          steps: [
            'Type your street name in the search bar',
            'Browse routes by tapping to expand route groups',
            'Tap any street to see detailed pickup status',
            'View start dates, completion dates, and notes'
          ]
        },
        {
          icon: '📸',
          title: 'Analyze Your Collection',
          description: 'Get AI-powered feedback on your leaf collection',
          steps: [
            'Tap the "Analyze Collection" button',
            'Take a photo or upload from your device',
            'Submit for instant AI analysis',
            'Receive compliance feedback and suggestions'
          ]
        },
        {
          icon: '📧',
          title: 'Get Email Alerts',
          description: 'Stay updated on your street\'s status',
          steps: [
            'Search for and select your street',
            'Tap to open detailed street information',
            'Fill out the email alert subscription form',
            'Get notified when pickup status changes'
          ]
        }
      ];

      return html`
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 pt-16 z-[100]" style=${{ touchAction: 'none' }}>
          <div 
            ref=${contentRef}
            className="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto relative z-[101]" 
            style=${{ touchAction: 'pan-y' }}
          >
            <div className="flex items-center justify-between p-4 border-b border-gray-200 sticky top-0 bg-white z-10">
              <div className="flex items-center">
                <span className="text-2xl md:text-3xl mr-3">💡</span>
                <div>
                  <h3 className="text-lg md:text-xl font-semibold text-green-800">
                    How to Use This App
                  </h3>
                  <p className="text-xs md:text-sm text-gray-600 mt-1">
                    Everything you need to track your leaf collection
                  </p>
                </div>
              </div>
              <button
                onClick=${onClose}
                className="text-gray-400 hover:text-gray-600 transition-colors p-2 rounded-lg hover:bg-gray-100 min-h-[44px] min-w-[44px] flex items-center justify-center"
                aria-label="Close help guide"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>

            <div className="p-4 md:p-6">
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                ${features.map((feature, index) => html`
                  <div 
                    key=${feature.title}
                    className="feature-card bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-4 md:p-6 border border-green-200 shadow-sm"
                  >
                    <div className="text-center mb-4">
                      <span className="text-3xl md:text-4xl mb-3 block">${feature.icon}</span>
                      <h3 className="text-base md:text-lg font-bold text-gray-900 mb-2">
                        ${index + 1}. ${feature.title}
                      </h3>
                      <p className="text-xs md:text-sm text-gray-600 leading-relaxed">
                        ${feature.description}
                      </p>
                    </div>
                    <div className="space-y-2 md:space-y-3">
                      ${feature.steps.map((step, stepIndex) => html`
                        <div key=${stepIndex} className="flex items-start space-x-2 md:space-x-3">
                          <span className="flex-shrink-0 w-5 h-5 md:w-6 md:h-6 bg-green-600 text-white text-xs rounded-full flex items-center justify-center font-bold">
                            ${stepIndex + 1}
                          </span>
                          <p className="text-xs md:text-sm text-gray-700 leading-relaxed">${step}</p>
                        </div>
                      `)}
                    </div>
                  </div>
                `)}
              </div>

              <div className="mt-6 text-center bg-blue-50 border border-blue-200 rounded-lg p-3">
                <p className="text-xs md:text-sm text-blue-700">
                  💡 <strong>Tip:</strong> You can access this guide anytime by tapping the "How to Use" button
                </p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    /**
     * ActiveCrewsModal Component
     * Modal to display all streets being collected on a specific active route
     */
    function ActiveCrewsModal({ isOpen, onClose, route, onStreetClick }) {
      if (!isOpen || !route) return null;

      return html`
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 pt-16 z-[100]" style=${{ touchAction: 'none' }}>
          <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto relative z-[101]" style=${{ touchAction: 'pan-y' }}>
            <div className="flex items-center justify-between p-4 border-b border-gray-200 bg-gradient-to-r from-orange-50 to-yellow-50 sticky top-0 z-[102]">
              <div className="flex items-center space-x-3">
                <span className="text-2xl">🚜</span>
                <div>
                  <h3 className="text-lg font-semibold text-orange-800">
                    Route ${route.routeNumber} - Crew Working Now
                  </h3>
                  <p className="text-sm text-orange-600 mt-1">
                    ${route.streets.length} ${route.streets.length === 1 ? 'street' : 'streets'} in progress
                  </p>
                </div>
              </div>
              <button
                onClick=${onClose}
                className="text-gray-400 hover:text-gray-600 transition-colors p-2 rounded-lg hover:bg-gray-100 min-h-[44px] min-w-[44px] flex items-center justify-center"
                aria-label="Close route details"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            
            <div className="p-4">
              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                <p className="text-sm text-yellow-800 flex items-center">
                  <span className="mr-2">⚠️</span>
                  This route is actively being collected. Tap any street to see detailed status and subscribe to alerts.
                </p>
              </div>

              <ul className="divide-y divide-gray-100 border border-gray-200 rounded-lg overflow-hidden">
                ${route.streets.map((street, index) => html`
                  <li key=${street.id}>
                    <button
                      type="button"
                      onClick=${() => {
                        onClose();
                        onStreetClick(street);
                      }}
                      className="flex w-full items-center justify-between px-4 py-3 min-h-[56px] text-left transition-all duration-200 hover:bg-orange-50"
                    >
                      <div className="flex items-center flex-1 space-x-3">
                        <span className="flex-shrink-0 w-6 h-6 bg-orange-500 text-white text-xs rounded-full flex items-center justify-center font-bold">
                          ${index + 1}
                        </span>
                        <div className="flex-1">
                          <p className="font-medium text-gray-900">${street.street}</p>
                          ${street.dateStarted ? html`
                            <p className="text-xs text-gray-500 mt-1">
                              Started: ${formatDate(street.dateStarted)}
                            </p>
                          ` : null}
                        </div>
                      </div>
                      <div className="flex items-center space-x-2">
                        <${StatusBadge} status=${street.status || 'Unknown'} />
                        <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                      </div>
                    </button>
                  </li>
                `)}
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    /**
     * ActiveCrews Component
     * Displays all routes currently "In Progress" to show where crews are actively working
     */
    function ActiveCrews({ onStreetClick }) {
      const [activeRoutes, setActiveRoutes] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [selectedRoute, setSelectedRoute] = useState(null);
      const [isModalOpen, setIsModalOpen] = useState(false);

      useEffect(() => {
        let isMounted = true;

        async function loadActiveCrews() {
          try {
            const response = await fetch('/api/streets');
            if (!response.ok) {
              throw new Error('Unable to fetch street data.');
            }

            const payload = await response.json();
            if (isMounted && Array.isArray(payload.records)) {
              // Filter for "In Progress" streets and group by route
              const inProgressStreets = payload.records.filter(
                record => normalizeStatus(record.status) === 'In Progress'
              );

              // Group by route number
              const routeMap = {};
              inProgressStreets.forEach(street => {
                const routeNum = street.routeNumber || 'Unknown';
                if (!routeMap[routeNum]) {
                  routeMap[routeNum] = {
                    routeNumber: routeNum,
                    streets: []
                  };
                }
                routeMap[routeNum].streets.push(street);
              });

              // Convert to array and sort by route number
              const routes = Object.values(routeMap).sort((a, b) => {
                const aNum = parseInt(a.routeNumber) || 999999;
                const bNum = parseInt(b.routeNumber) || 999999;
                return aNum - bNum;
              });

              setActiveRoutes(routes);
            }
          } catch (err) {
            console.error('Error loading active crews:', err);
            if (isMounted) {
              setError('Unable to load active crew locations.');
            }
          } finally {
            if (isMounted) {
              setLoading(false);
            }
          }
        }

        loadActiveCrews();

        // Refresh every 5 minutes
        const interval = setInterval(loadActiveCrews, 5 * 60 * 1000);

        return () => {
          isMounted = false;
          clearInterval(interval);
        };
      }, []);

      const openRouteModal = (route) => {
        setSelectedRoute(route);
        setIsModalOpen(true);
      };

      const closeRouteModal = () => {
        setIsModalOpen(false);
        setSelectedRoute(null);
      };

      // Don't render if loading, error, or no active routes
      if (loading || error || activeRoutes.length === 0) {
        return null;
      }

      return html`
        <div className="bg-gradient-to-r from-yellow-50 via-orange-50 to-yellow-50 rounded-2xl shadow-lg border-2 border-yellow-400 p-4 md:p-6">
          <div className="flex items-center mb-4">
            <span className="text-2xl mr-2 animate-pulse">🚜</span>
            <div className="flex-1">
              <h2 className="text-xl md:text-2xl font-bold text-orange-800">
                Crews Currently Working
              </h2>
              <p className="text-sm text-orange-600 mt-1">
                ${activeRoutes.length} ${activeRoutes.length === 1 ? 'route' : 'routes'} in progress right now • Tap to see all streets
              </p>
            </div>
            <div className="hidden md:flex items-center space-x-2 bg-orange-100 px-3 py-2 rounded-lg">
              <span className="text-xs font-medium text-orange-800">Live Status</span>
              <div className="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>
            </div>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            ${activeRoutes.map((route) => {
              const streetCount = route.streets.length;
              const streetsList = route.streets.map(s => s.street).slice(0, 3);
              const hasMore = route.streets.length > 3;
              
              return html`
                <button
                  type="button"
                  key=${route.routeNumber}
                  onClick=${() => openRouteModal(route)}
                  className="bg-white rounded-xl p-4 border-2 border-orange-200 shadow-sm hover:shadow-lg hover:border-orange-300 transition-all duration-200 text-left w-full cursor-pointer"
                >
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center space-x-2">
                      <span className="text-2xl">🔄</span>
                      <h3 className="text-lg font-bold text-orange-800">
                        Route ${route.routeNumber}
                      </h3>
                    </div>
                    <span className="bg-yellow-100 text-yellow-800 text-xs font-medium px-2 py-1 rounded-full">
                      ${streetCount} ${streetCount === 1 ? 'street' : 'streets'}
                    </span>
                  </div>
                  
                  <div className="space-y-1">
                    <p className="text-xs font-medium text-gray-600 mb-2">Currently on:</p>
                    ${streetsList.map(street => html`
                      <div key=${street} className="text-sm text-gray-700 flex items-center">
                        <span className="w-1.5 h-1.5 bg-orange-400 rounded-full mr-2"></span>
                        ${street}
                      </div>
                    `)}
                    ${hasMore && html`
                      <p className="text-xs text-orange-600 font-medium mt-2 flex items-center">
                        <span className="mr-1">👆</span>
                        Click to see all ${route.streets.length} streets
                      </p>
                    `}
                  </div>
                </button>
              `;
            })}
          </div>
          
          <div className="mt-4 flex items-center justify-center text-xs text-orange-700 bg-orange-100 rounded-lg p-2">
            <span className="mr-2">ℹ️</span>
            Updates automatically every 5 minutes • Last updated: ${new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
          </div>

          <${ActiveCrewsModal} 
            isOpen=${isModalOpen} 
            onClose=${closeRouteModal} 
            route=${selectedRoute}
            onStreetClick=${onStreetClick}
          />
        </div>
      `;
    }

    /**
     * UpNextRoutesModal Component
     * Modal to display all streets scheduled on a specific "Up Next" route
     */
    function UpNextRoutesModal({ isOpen, onClose, route, onStreetClick }) {
      if (!isOpen || !route) return null;

      return html`
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 pt-16 z-[100]" style=${{ touchAction: 'none' }}>
          <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto relative z-[101]" style=${{ touchAction: 'pan-y' }}>
            <div className="flex items-center justify-between p-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50 sticky top-0 z-[102]">
              <div className="flex items-center space-x-3">
                <span className="text-2xl">🔜</span>
                <div>
                  <h3 className="text-lg font-semibold text-blue-800">
                    Route ${route.routeNumber} - Up Next
                  </h3>
                  <p className="text-sm text-blue-600 mt-1">
                    ${route.streets.length} ${route.streets.length === 1 ? 'street' : 'streets'} scheduled to start soon
                  </p>
                </div>
              </div>
              <button
                onClick=${onClose}
                className="text-gray-400 hover:text-gray-600 transition-colors p-2 rounded-lg hover:bg-gray-100 min-h-[44px] min-w-[44px] flex items-center justify-center"
                aria-label="Close route details"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            
            <div className="p-4">
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                <p className="text-sm text-blue-800 flex items-center">
                  <span className="mr-2">⏰</span>
                  This route is scheduled to start soon. Tap any street to see detailed status and subscribe to alerts.
                </p>
              </div>

              <ul className="divide-y divide-gray-100 border border-gray-200 rounded-lg overflow-hidden">
                ${route.streets.map((street, index) => html`
                  <li key=${street.id}>
                    <button
                      type="button"
                      onClick=${() => {
                        onClose();
                        onStreetClick(street);
                      }}
                      className="flex w-full items-center justify-between px-4 py-3 min-h-[56px] text-left transition-all duration-200 hover:bg-blue-50"
                    >
                      <div className="flex items-center flex-1 space-x-3">
                        <span className="flex-shrink-0 w-6 h-6 bg-blue-500 text-white text-xs rounded-full flex items-center justify-center font-bold">
                          ${index + 1}
                        </span>
                        <div className="flex-1">
                          <p className="font-medium text-gray-900">${street.street}</p>
                          ${street.dateStarted ? html`
                            <p className="text-xs text-gray-500 mt-1">
                              Scheduled: ${formatDate(street.dateStarted)}
                            </p>
                          ` : null}
                        </div>
                      </div>
                      <div className="flex items-center space-x-2">
                        <${StatusBadge} status=${street.status || 'Unknown'} />
                        <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                      </div>
                    </button>
                  </li>
                `)}
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    /**
     * UpNextRoutes Component
     * Displays all routes with "Up Next" status to show what's coming soon
     */
    function UpNextRoutes({ onStreetClick }) {
      const [upNextRoutes, setUpNextRoutes] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [selectedRoute, setSelectedRoute] = useState(null);
      const [isModalOpen, setIsModalOpen] = useState(false);

      useEffect(() => {
        let isMounted = true;

        async function loadUpNextRoutes() {
          try {
            const response = await fetch('/api/streets');
            if (!response.ok) {
              throw new Error('Unable to fetch street data.');
            }

            const payload = await response.json();
            if (isMounted && Array.isArray(payload.records)) {
              // Filter for "Up Next" streets and group by route
              const upNextStreets = payload.records.filter(
                record => normalizeStatus(record.status) === 'Up Next'
              );

              // Group by route number
              const routeMap = {};
              upNextStreets.forEach(street => {
                const routeNum = street.routeNumber || 'Unknown';
                if (!routeMap[routeNum]) {
                  routeMap[routeNum] = {
                    routeNumber: routeNum,
                    streets: []
                  };
                }
                routeMap[routeNum].streets.push(street);
              });

              // Convert to array and sort by route number
              const routes = Object.values(routeMap).sort((a, b) => {
                const aNum = parseInt(a.routeNumber) || 999999;
                const bNum = parseInt(b.routeNumber) || 999999;
                return aNum - bNum;
              });

              setUpNextRoutes(routes);
            }
          } catch (err) {
            console.error('Error loading up next routes:', err);
            if (isMounted) {
              setError('Unable to load upcoming routes.');
            }
          } finally {
            if (isMounted) {
              setLoading(false);
            }
          }
        }

        loadUpNextRoutes();

        // Refresh every 5 minutes
        const interval = setInterval(loadUpNextRoutes, 5 * 60 * 1000);

        return () => {
          isMounted = false;
          clearInterval(interval);
        };
      }, []);

      const openRouteModal = (route) => {
        setSelectedRoute(route);
        setIsModalOpen(true);
      };

      const closeRouteModal = () => {
        setIsModalOpen(false);
        setSelectedRoute(null);
      };

      // Don't render if loading, error, or no up next routes
      if (loading || error || upNextRoutes.length === 0) {
        return null;
      }

      return html`
        <div className="bg-gradient-to-r from-blue-50 via-indigo-50 to-blue-50 rounded-2xl shadow-lg border-2 border-blue-400 p-4 md:p-6">
          <div className="flex items-center mb-4">
            <span className="text-2xl mr-2">🔜</span>
            <div className="flex-1">
              <h2 className="text-xl md:text-2xl font-bold text-blue-800">
                Routes Up Next
              </h2>
              <p className="text-sm text-blue-600 mt-1">
                ${upNextRoutes.length} ${upNextRoutes.length === 1 ? 'route' : 'routes'} scheduled to start soon • Tap to see all streets
              </p>
            </div>
            <div className="hidden md:flex items-center space-x-2 bg-blue-100 px-3 py-2 rounded-lg">
              <span className="text-xs font-medium text-blue-800">Coming Soon</span>
              <span className="text-blue-500">⏰</span>
            </div>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            ${upNextRoutes.map((route) => {
              const streetCount = route.streets.length;
              const streetsList = route.streets.map(s => s.street).slice(0, 3);
              const hasMore = route.streets.length > 3;
              
              return html`
                <button
                  type="button"
                  key=${route.routeNumber}
                  onClick=${() => openRouteModal(route)}
                  className="bg-white rounded-xl p-4 border-2 border-blue-200 shadow-sm hover:shadow-lg hover:border-blue-300 transition-all duration-200 text-left w-full cursor-pointer"
                >
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center space-x-2">
                      <span className="text-2xl">📍</span>
                      <h3 className="text-lg font-bold text-blue-800">
                        Route ${route.routeNumber}
                      </h3>
                    </div>
                    <span className="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">
                      ${streetCount} ${streetCount === 1 ? 'street' : 'streets'}
                    </span>
                  </div>
                  
                  <div className="space-y-1">
                    <p className="text-xs font-medium text-gray-600 mb-2">Includes:</p>
                    ${streetsList.map(street => html`
                      <div key=${street} className="text-sm text-gray-700 flex items-center">
                        <span className="w-1.5 h-1.5 bg-blue-400 rounded-full mr-2"></span>
                        ${street}
                      </div>
                    `)}
                    ${hasMore && html`
                      <p className="text-xs text-blue-600 font-medium mt-2 flex items-center">
                        <span className="mr-1">👆</span>
                        Click to see all ${route.streets.length} streets
                      </p>
                    `}
                  </div>
                </button>
              `;
            })}
          </div>
          
          <div className="mt-4 flex items-center justify-center text-xs text-blue-700 bg-blue-100 rounded-lg p-2">
            <span className="mr-2">ℹ️</span>
            These routes will begin once current routes are completed
          </div>

          <${UpNextRoutesModal} 
            isOpen=${isModalOpen} 
            onClose=${closeRouteModal} 
            route=${selectedRoute}
            onStreetClick=${onStreetClick}
          />
        </div>
      `;
    }

    /**
     * ServiceMessages Component
     * Displays messages from the service department fetched from Airtable
     */
    function ServiceMessages() {
      const [messages, setMessages] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      useEffect(() => {
        let isMounted = true;

        async function loadMessages() {
          try {
            const response = await fetch('/api/messages');
            if (!response.ok) {
              const errorText = await response.text();
              console.error('API error response:', response.status, errorText);
              throw new Error(`Unable to fetch messages (${response.status})`);
            }

            const payload = await response.json();
            if (isMounted) {
              // Sort messages by date (newest first) on client side
              const sortedMessages = Array.isArray(payload.messages) 
                ? payload.messages.sort((a, b) => {
                    if (!a.dateCreated) return 1;
                    if (!b.dateCreated) return -1;
                    return new Date(b.dateCreated) - new Date(a.dateCreated);
                  })
                : [];
              setMessages(sortedMessages);
            }
          } catch (err) {
            console.error('Error loading messages:', err);
            if (isMounted) {
              setError('Unable to load service messages.');
            }
          } finally {
            if (isMounted) {
              setLoading(false);
            }
          }
        }

        loadMessages();

        return () => {
          isMounted = false;
        };
      }, []);

      // Don't render anything if loading, error, or no messages
      if (loading || error || messages.length === 0) {
        return null;
      }

      /**
       * Format date for display
       * @param {string} dateStr - ISO date string
       * @returns {string} Formatted date
       */
      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        try {
          const date = new Date(dateStr);
          return date.toLocaleDateString('en-US', { 
            month: 'long', 
            day: 'numeric', 
            year: 'numeric' 
          });
        } catch (e) {
          return dateStr;
        }
      };

      return html`
        <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200 p-4 md:p-6">
          <div className="flex items-center mb-4">
            <span className="text-2xl mr-2">📢</span>
            <h2 className="text-xl md:text-2xl font-bold text-green-800">
              Service Department Updates
            </h2>
          </div>
          
          <div className="space-y-3">
            ${messages.map((msg) => html`
              <div 
                key=${msg.id}
                className="bg-gray-50 rounded-lg p-4 border border-gray-200"
              >
                <p className="text-gray-800 text-base leading-relaxed mb-2">
                  ${msg.message}
                </p>
                ${msg.dateCreated && html`
                  <p className="text-sm text-gray-500">
                    Posted on ${formatDate(msg.dateCreated)}
                  </p>
                `}
              </div>
            `)}
          </div>
        </div>
      `;
    }

    function App() {
      const [records, setRecords] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [activeId, setActiveId] = useState(null);
      const [sortBy, setSortBy] = useState('street');
      const [showAnalyzerModal, setShowAnalyzerModal] = useState(false);
      const [modalRecord, setModalRecord] = useState(null);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [expandedRoutes, setExpandedRoutes] = useState(new Set());
      const [showOnboarding, setShowOnboarding] = useState(false);

      useEffect(() => {
        let isMounted = true;

        async function loadData() {
          try {
            const response = await fetch('/api/streets');
            if (!response.ok) {
              throw new Error('Unable to fetch street data.');
            }

            const payload = await response.json();
            if (isMounted) {
              const records = Array.isArray(payload.records) ? payload.records : [];
              // Debug logging to see what statuses we're getting
              console.log('Sample records with statuses:', records.slice(0, 5).map(r => ({ street: r.street, status: r.status })));
              setRecords(records);
            }
          } catch (err) {
            console.error(err);
            if (isMounted) {
              setError(
                'Unable to load the latest collection information right now. Please try again soon.'
              );
            }
          } finally {
            if (isMounted) {
              setLoading(false);
            }
          }
        }

        loadData();

        return () => {
          isMounted = false;
        };
      }, []);

      const sortedRecords = useMemo(() => {
        const filtered = [...records].filter((record) => Boolean(record.street));
        
        return filtered.sort((a, b) => {
          switch (sortBy) {
            case 'status':
              const statusOrder = { 
                'Not Started': 0, 
                'Up Next': 1,
                'In Progress': 2, 
                'Completed 1st Pass': 3,
                'Completed 2nd Pass': 4,
                'Completed 3rd Pass': 5,
                'Completed 4th Pass': 6,
                'Completed': 7
              };
              const aStatus = normalizeStatus(a.status || 'Unknown');
              const bStatus = normalizeStatus(b.status || 'Unknown');
              const aOrder = statusOrder[aStatus] ?? 999;
              const bOrder = statusOrder[bStatus] ?? 999;
              if (aOrder !== bOrder) return aOrder - bOrder;
              return a.street.localeCompare(b.street);
            case 'route':
              const aRoute = parseInt(a.routeNumber) || 999;
              const bRoute = parseInt(b.routeNumber) || 999;
              if (aRoute !== bRoute) return aRoute - bRoute;
              return a.street.localeCompare(b.street);
            case 'street':
            default:
              return a.street.localeCompare(b.street);
          }
        });
      }, [records, sortBy]);

      const filteredRecords = useMemo(() => {
        const term = searchTerm.trim().toLowerCase();
        if (!term) {
          return sortedRecords;
        }

        return sortedRecords.filter((record) =>
          record.street.toLowerCase().includes(term)
        );
      }, [sortedRecords, searchTerm]);

      // Group filtered records by route number
      const routeGroups = useMemo(() => {
        const groups = {};
        
        filteredRecords.forEach((record) => {
          const route = record.routeNumber || 'Unknown';
          if (!groups[route]) {
            groups[route] = [];
          }
          groups[route].push(record);
        });

        // Convert to array and sort by route number
        return Object.entries(groups)
          .sort((a, b) => {
            const aNum = parseInt(a[0]) || 999999;
            const bNum = parseInt(b[0]) || 999999;
            return aNum - bNum;
          })
          .map(([routeNumber, records]) => ({
            routeNumber,
            records,
          }));
      }, [filteredRecords]);

      // Toggle route expansion
      const toggleRoute = (routeNumber) => {
        setExpandedRoutes(prev => {
          const newSet = new Set(prev);
          if (newSet.has(routeNumber)) {
            newSet.delete(routeNumber);
          } else {
            newSet.add(routeNumber);
          }
          return newSet;
        });
      };

      useEffect(() => {
        if (!activeId && filteredRecords.length > 0) {
          setActiveId(filteredRecords[0].id);
        }
      }, [filteredRecords, activeId]);

      const selectedRecord = useMemo(() => {
        if (!activeId) {
          return null;
        }

        return records.find((record) => record.id === activeId) ?? null;
      }, [records, activeId]);

      const openModal = (record) => {
        setModalRecord(record);
        setIsModalOpen(true);
      };

      const closeModal = () => {
        setIsModalOpen(false);
        setModalRecord(null);
      };

      let mainContent;

      if (loading) {
        mainContent = html`<div className="mt-8">
          <${LoadingSpinner} />
        </div>`;
      } else if (error) {
        mainContent = html`<div className="mt-8 rounded-lg bg-red-50 border border-red-200 p-6">
          <div className="flex items-center">
            <div className="text-red-500 text-xl mr-3">⚠️</div>
            <div>
              <h3 className="text-sm font-medium text-red-800">Unable to load data</h3>
              <p className="text-sm text-red-700 mt-1">${error}</p>
            </div>
          </div>
        </div>`;
      } else {
        // Check if user is searching
        const isSearching = searchTerm.trim().length > 0;
        
        const resultsList =
          filteredRecords.length === 0
            ? html`<div className="p-6 text-center">
                <div className="text-4xl mb-3">🔍</div>
                <p className="text-sm text-gray-500">
                  No streets match that search. Try another name or double-check your spelling.
                </p>
              </div>`
            : isSearching
              ? html`<div className="divide-y divide-gray-100">
                  ${filteredRecords.map((record) => html`
                    <button
                      key=${record.id}
                      type="button"
                      onClick=${() => openModal(record)}
                      className="flex w-full items-center justify-between px-4 py-3 min-h-[56px] text-left transition-all duration-200 hover:bg-green-50"
                    >
                      <div className="flex-1">
                        <p className="font-medium text-gray-900">
                          ${record.street}
                          ${record.routeNumber ? html`
                            <span className="ml-2 text-sm text-green-700 font-normal">
                              (Route #${record.routeNumber})
                            </span>
                          ` : null}
                        </p>
                      </div>
                      <div className="flex items-center space-x-2">
                        <${StatusBadge} status=${record.status || 'Unknown'} />
                        <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                      </div>
                    </button>
                  `)}
                </div>`
              : html`<div className="space-y-2">
                  ${routeGroups.map((group) => {
                    return html`<${CollapsibleRoute}
                      key=${group.routeNumber}
                      routeNumber=${group.routeNumber}
                      records=${group.records}
                      isExpanded=${expandedRoutes.has(group.routeNumber)}
                      onToggle=${() => toggleRoute(group.routeNumber)}
                      onStreetClick=${openModal}
                    />`;
                  })}
                </div>`;


        mainContent = html`<div className="mt-8 space-y-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-2">
              <span className="text-sm font-medium text-gray-600">
                ${routeGroups.length} ${routeGroups.length === 1 ? 'route' : 'routes'} • ${filteredRecords.length} ${filteredRecords.length === 1 ? 'street' : 'streets'}
              </span>
              ${filteredRecords.length > 0 ? html`<span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                ${filteredRecords.filter(r => isCompletedStatus(r.status)).length} completed
              </span>` : null}
            </div>
            ${searchTerm
              ? html`<button
                  type="button"
                  onClick=${() => {
                    setSearchTerm('');
                    setActiveId(null);
                  }}
                  className="text-sm text-green-600 hover:text-green-700 font-medium"
                >
                  Clear search
                </button>`
              : null}
          </div>
          <div className="max-h-96 overflow-y-auto rounded-lg border border-gray-200 bg-white/90 backdrop-blur-sm shadow-sm scroll-container">
            ${resultsList}
          </div>
        </div>`;
      }

      return html`<div className="min-h-screen app-background px-3 md:px-4 py-6 md:py-10">
        <div className="mx-auto flex max-w-6xl flex-col gap-4 md:gap-8 app-content">
          <header className="text-center">
            <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg p-4 md:p-8 border border-green-200">
              <div className="flex items-center justify-center mb-3 md:mb-4">
                <div className="text-3xl md:text-4xl mr-2 md:mr-3">🍂</div>
                <h1 className="text-2xl md:text-4xl font-bold text-green-800">
                  Westlake Leaf Collection Tracker
                </h1>
              </div>
              <p className="text-base md:text-lg text-gray-600 mb-3 md:mb-4">
                Search your street to see the latest pickup status
              </p>
              <div className="flex gap-3 justify-center mb-2 flex-wrap">
                <button
                  onClick=${() => setShowAnalyzerModal(true)}
                  className="bg-blue-600 text-white px-6 py-3 min-h-[48px] rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center"
                >
                  <span className="mr-2">📸</span>
                  Analyze Collection
                </button>
                <button
                  onClick=${() => setShowOnboarding(true)}
                  className="bg-green-600 text-white px-6 py-3 min-h-[48px] rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center"
                >
                  <span className="mr-2">💡</span>
                  How to Use
                </button>
              </div>
              <p className="text-sm text-gray-500">
                Updated daily by the Westlake Service Department
              </p>
            </div>
          </header>

          <${ActiveCrews} onStreetClick=${openModal} />
          <${UpNextRoutes} onStreetClick=${openModal} />

          <${ServiceMessages} />

          <main className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
            <div className="bg-gradient-to-r from-green-600 to-green-700 px-4 md:px-6 py-3 md:py-4">
              <div className="flex flex-col gap-4">
                <label className="text-sm font-medium text-white flex items-center" htmlFor="street-search">
                  <span className="mr-2">🔍</span>
                  Search for your street
                </label>
                <input
                  id="street-search"
                  type="search"
                  placeholder="Start typing to find your street..."
                  value=${searchTerm}
                  onChange=${(event) => setSearchTerm(event.target.value)}
                  className="w-full rounded-lg border-0 px-4 py-3 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 bg-white text-gray-900 placeholder-gray-500"
                />
              </div>
            </div>
            
            <div className="p-4 md:p-6">
              ${mainContent}
            </div>
          </main>
        </div>
        
        <footer className="mt-8 pt-6 border-t border-gray-200">
          <div className="text-center text-sm text-gray-600">
            <p className="mb-2">
              © 2024 City of Westlake, OH. All rights reserved.
            </p>
            <div className="flex justify-center space-x-4">
              <a 
                href="privacy-policy.html" 
                className="text-green-600 hover:text-green-700 underline"
                target="_blank"
                rel="noopener noreferrer"
              >
                Privacy Policy
              </a>
              <span className="text-gray-400">•</span>
              <a 
                href="terms-of-service.html" 
                className="text-green-600 hover:text-green-700 underline"
                target="_blank"
                rel="noopener noreferrer"
              >
                Terms of Service
              </a>
            </div>
          </div>
        </footer>
        
        <${RouteModal} record=${modalRecord} isOpen=${isModalOpen} onClose=${closeModal} />
        <${CameraAnalysisModal} isOpen=${showAnalyzerModal} onClose=${() => setShowAnalyzerModal(false)} />
        <${HowToUse} isOpen=${showOnboarding} onClose=${() => setShowOnboarding(false)} />
        <${InstallPrompt} />
      </div>`;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(html`<${App} />`);
  </script>
</body>
</html>
